(()=>{function e(r){if(n[r])return n[r].exports;var o=n[r]={exports:{}};return t[r].call(o.exports,o,o.exports,e),o.exports}var t={1169:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},9010:(e,t)=>{function n(e,n){return{actionClass:t.badgingActionClass,topic:e,...n}}var r;Object.defineProperty(t,"__esModule",{value:!0}),t.createBadgingActionForTopic=t.createBadgingAction=t.BadgeClientIdentifier=t.badgingActionClass=void 0,t.badgingActionClass="BadgingAction",function(e){e[e.appStore=0]="appStore",e[e.news=1]="news"}(r=t.BadgeClientIdentifier||(t.BadgeClientIdentifier={})),t.createBadgingAction=function(e,t){return n(function(e){switch(e){case r.appStore:return{topic:"com.apple.AppStore"};case r.news:return{topic:"com.apple.news"};default:return{topic:""}}}(e).topic,t)},t.createBadgingActionForTopic=n},1542:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createCacheDataAction=t.cacheDataActionClass=void 0,t.cacheDataActionClass="CacheDataAction",t.createCacheDataAction=function(e,n,r,o){return{actionClass:t.cacheDataActionClass,data:e,duration:o,filter:n,key:r}}},5350:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createCarrierOfferRegistrationAction=t.carrierOfferRegistrationActionClass=void 0,t.carrierOfferRegistrationActionClass="CarrierOfferRegistrationAction",t.createCarrierOfferRegistrationAction=function(e={}){return{actionClass:t.carrierOfferRegistrationActionClass,throttleInterval:e.throttleInterval}}},8538:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createEnqueueAction=t.enqueueActionClass=void 0,t.enqueueActionClass="EnqueueAction",t.createEnqueueAction=function(e,n){return{actionClass:t.enqueueActionClass,events:e,schedule:null==n?void 0:n.schedule}}},5855:(e,t)=>{function n(e,n){const r=n;let o=!1;return"iOS"===host.platform?o=!host.isOSAtLeast(16,2,0):"macOS"===host.platform?o=!host.isOSAtLeast(13,1,0):"tvOS"===host.platform?o=!host.isOSAtLeast(16,2,0):"watchOS"===host.platform&&(o=!host.isOSAtLeast(9,2,0)),o&&"string"==typeof r.accountDSID&&(r.accountDSID=Number(r.accountDSID)),{actionClass:t.followUpNotificationActionClass,identifier:e,data:r}}Object.defineProperty(t,"__esModule",{value:!0}),t.createFollowUpNotificationActionWithNativeContent=t.createFollowUpNotificationAction=t.followUpNotificationActionClass=void 0,t.followUpNotificationActionClass="FollowUpNotificationAction",t.createFollowUpNotificationAction=function(e,t){var r,o;const i=[];return null===(r=t.actions)||void 0===r||r.forEach((e=>{i.push({clientActionDeepLink:e.clientActionDeepLink,financeLink:e.financeURL,metrics:e.metrics,serverActionUrl:e.request,clear:e.shouldClear,title:e.title})})),n(e,{actions:i,clear:t.shouldClear,expirationDate:t.expirationDate,deviceGroup:t.deviceGroup,disableGrouping:!t.deviceGroup,footer:t.footer,hardwareOffer:t.isHardwareOffer,iconImageName:t.iconImageName,metrics:t.metrics,notification:t.shouldPostNotification,omitBadge:t.shouldOmitBadge,text:t.informativeText,title:t.title,zeroAction:t.zeroAction,priority:null!==(o=t.priority)&&void 0!==o?o:0,accountDSID:t.accountDSID})},t.createFollowUpNotificationActionWithNativeContent=n},3870:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),o(n(9010),t),o(n(1542),t),o(n(5350),t),o(n(8538),t),o(n(5855),t),o(n(5908),t),o(n(168),t),o(n(5984),t),o(n(447),t),o(n(714),t)},5908:(e,t)=>{var n,r,o,i;Object.defineProperty(t,"__esModule",{value:!0}),t.createMessageAction=t.PlacementActionType=t.ActionStyle=t.MessageImageStyle=t.MessageStyle=t.messageActionClass=void 0,t.messageActionClass="MessageAction",(i=t.MessageStyle||(t.MessageStyle={}))[i.default=0]="default",i[i.alert=1]="alert",i[i.sheet=2]="sheet",i[i.banner=3]="banner",i[i.bubbleTip=4]="bubbleTip",i[i.toast=5]="toast",i[i.dashboard=6]="dashboard",i[i.account=7]="account",i[i.bubbleTipCompact=8]="bubbleTipCompact",(o=t.MessageImageStyle||(t.MessageImageStyle={}))[o.automatic=0]="automatic",o[o.image=1]="image",o[o.artwork=2]="artwork",(r=t.ActionStyle||(t.ActionStyle={}))[r.default=0]="default",r[r.destructive=1]="destructive",r[r.cancel=2]="cancel",(n=t.PlacementActionType||(t.PlacementActionType={})).present="present",n.dismiss="dismiss",t.createMessageAction=function(e,n){return{actionClass:t.messageActionClass,serviceType:e,dialogRequest:null==n?void 0:n.dialogRequest,engagementRequest:null==n?void 0:n.engagementRequest,placements:null==n?void 0:n.placements}}},168:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createOpenURLAction=t.deepLinkActionClass=void 0,t.deepLinkActionClass="DeepLinkAction",t.createOpenURLAction=function(e){return{actionClass:t.deepLinkActionClass,url:e}}},5984:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createSyncAction=t.syncActionClass=void 0,t.syncActionClass="SyncAction",t.createSyncAction=function(e){return{actionClass:t.syncActionClass,context:null==e?void 0:e.context,schedule:null==e?void 0:e.schedule}}},447:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createSystemEngagementAction=t.systemEngagementActionClass=void 0,t.systemEngagementActionClass="SystemEngagementAction",t.createSystemEngagementAction=function(e,n){return{actionClass:t.systemEngagementActionClass,request:e,account:null==n?void 0:n.account}}},714:(e,t)=>{var n,r;Object.defineProperty(t,"__esModule",{value:!0}),t.createUserNotificationAction=t.UserNotificationInterruptionLevel=t.UserNotificationClientId=t.userNotificationActionClass=void 0,t.userNotificationActionClass="UserNotificationAction",function(e){e[e.applemediaservices=0]="applemediaservices",e[e.appstore=1]="appstore",e[e.fitness=2]="fitness",e[e.ibooks=3]="ibooks",e[e.itunesstore=4]="itunesstore",e[e.music=5]="music",e[e.tv=6]="tv",e[e.news=7]="news",e[e.podcasts=8]="podcasts",e[e.wallet=9]="wallet"}(n=t.UserNotificationClientId||(t.UserNotificationClientId={})),(r=t.UserNotificationInterruptionLevel||(t.UserNotificationInterruptionLevel={}))[r.passive=0]="passive",r[r.active=1]="active",r[r.timeSensitive=2]="timeSensitive",r[r.critical=3]="critical",t.createUserNotificationAction=function(e,r){var o,i;const a=[];null===(o=r.buttons)||void 0===o||o.forEach((e=>{var t,n,r;a.push({_id:e.id,_gl:e.systemImageName,_mt:e.metrics,_rb:null===(t=e.request)||void 0===t?void 0:t.body,_rm:null===(n=e.request)||void 0===n?void 0:n.method,_ru:null===(r=e.request)||void 0===r?void 0:r.url,_tl:e.title,_url:e.url,_tp:e.defaultButton})}));const c=function(e){switch(e){case n.applemediaservices:return{bundleID:"com.apple.AppleMediaServicesUI.engagement.notifications",extensionID:"ams-notifications-extension"};case n.appstore:return{bundleID:"com.apple.AppStore",extensionID:"asd-notification-default"};case n.fitness:return{bundleID:"com.apple.Fitness",extensionID:"fitcored-engagement-category"};case n.ibooks:return{bundleID:"macos"===host.platform.toString()?"com.apple.iBooksX":"com.apple.iBooks",extensionID:"books-notification-extension"};case n.itunesstore:return{bundleID:"com.apple.MobileStore",extensionID:"mst-notification-category"};case n.music:return{bundleID:"com.apple.Music",extensionID:"music-notification-default"};case n.news:return{bundleID:"com.apple.news",extensionID:"extension-marketing"};case n.podcasts:return{bundleID:"com.apple.podcasts",extensionID:"com.apple.podcasts.announcement"};case n.tv:return{bundleID:"com.apple.tv",extensionID:"com.apple.tv-default"};case n.wallet:return{bundleID:"com.apple.Passbook",extensionID:"com.apple.passkit.engagement-notification-extension"};default:return{bundleID:"",extensionID:""}}}(e);return{actionClass:t.userNotificationActionClass,bundleID:c.bundleID,data:{_au:r.artworkURL,_ba:a,_del:r.delete,_delAll:r.deleteAll,_ex:r.explicit,_id:r.id,_mt:r.metrics,_ss:r.subsections,_vu:r.videoURL,alert:{body:r.message,level:r.interruptionLevel,title:r.title,subtitle:r.subtitle},category:c.extensionID,_an:null!==(i=r.anonymous)&&void 0!==i&&i}}}},1846:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},3386:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isAccountChangedEvent=t.accountChangedEventType=void 0,t.accountChangedEventType="AccountChanged",t.isAccountChangedEvent=function(e){return e.eventType===t.accountChangedEventType}},3368:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isContentFailedEvent=t.isContentAvailableEvent=t.contentFailedEventType=t.contentAvailableEventType=void 0,t.contentAvailableEventType="ContentAvailable",t.contentFailedEventType="ContentFailed",t.isContentAvailableEvent=function(e){return e.eventType===t.contentAvailableEventType},t.isContentFailedEvent=function(e){return e.eventType===t.contentFailedEventType}},4094:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},9550:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),o(n(3386),t),o(n(3368),t),o(n(4094),t),o(n(4126),t),o(n(4668),t),o(n(8064),t)},4126:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isMessageRequestEvent=t.messageRequestEventType=void 0,t.messageRequestEventType="MessageRequest",t.isMessageRequestEvent=function(e){return e.eventType===t.messageRequestEventType}},4668:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.isSubscriptionChangedEvent=t.SubscriptionChangedSegment=t.subscriptionChangedEventType=void 0,t.subscriptionChangedEventType="SubscriptionChanged",(n=t.SubscriptionChangedSegment||(t.SubscriptionChangedSegment={}))[n.news=0]="news",n[n.appStore=1]="appStore",n[n.activity=2]="activity",n[n.music=3]="music",n[n.tv=4]="tv",n[n.icloud=5]="icloud",n[n.podcast=6]="podcast",t.isSubscriptionChangedEvent=function(e){return e.eventType===t.subscriptionChangedEventType}},8064:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isUbiquitousStoreChangedEvent=t.ubiquitousStoreChangedEventType=void 0,t.ubiquitousStoreChangedEventType="UbiqutiousStoreChanged",t.isUbiquitousStoreChangedEvent=function(e){return e.eventType===t.ubiquitousStoreChangedEventType}},9089:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),t.exportEngagementService=t.actions=void 0,o(n(1169),t),t.actions=n(3870),o(n(1846),t),o(n(9550),t),o(n(8890),t),o(n(9615),t),t.exportEngagementService=function(e){exportService("EngagementService",e)}},6059:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.AccountMediaType=void 0,(n=t.AccountMediaType||(t.AccountMediaType={}))[n.appStore=100]="appStore",n[n.appStoreBeta=101]="appStoreBeta",n[n.appStoreSandbox=102]="appStoreSandbox",n[n.books=200]="books",n[n.iTunes=300]="iTunes",n[n.production=400]="production"},7776:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},4056:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.PredicateType=void 0,(n=t.PredicateType||(t.PredicateType={})).and="and",n.app="app",n.greaterThan="greaterThan",n.lessThan="lessThan",n.like="like",n.or="or"},7090:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},9541:(e,t)=>{var n,r;Object.defineProperty(t,"__esModule",{value:!0}),t.getContentInfo=t.isContentFinishedEvent=t.Method=t.ContentState=void 0,(r=t.ContentState||(t.ContentState={}))[r.unknown=0]="unknown",r[r.downloading=1]="downloading",r[r.available=2]="available",(n=t.Method||(t.Method={})).delete="DELETE",n.get="GET",n.head="HEAD",n.options="OPTIONS",n.patch="PATCH",n.post="POST",n.put="PUT",n.trace="TRACE",n.update="UPDATE",t.isContentFinishedEvent=function(e){const t=e;return"ContentAvailable"===t.eventType&&"amsengagementd"===t.source},t.getContentInfo=function(e,t){let n=!1;switch(host.platform){case"iOS":case"tvOS":n=!host.isOSAtLeast(16,4,0);break;case"macOS":n=!host.isOSAtLeast(13,3,0);break;case"watchOS":n=!host.isOSAtLeast(9,4,0)}return n?AMS.content.info(e,null==t?void 0:t.version):AMS.content.info(e,t)}},7837:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},6946:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},7839:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},9169:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.FamilyEligibility=void 0,(n=t.FamilyEligibility||(t.FamilyEligibility={}))[n.unknown=0]="unknown",n[n.ineligible=1]="ineligible",n[n.eligible=2]="eligible"},9971:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},8890:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),o(n(6059),t),o(n(7776),t),o(n(4056),t),o(n(7090),t),o(n(9541),t),o(n(7837),t),o(n(6946),t),o(n(7839),t),o(n(9169),t),o(n(9971),t),o(n(5069),t),o(n(5643),t),o(n(6091),t),o(n(721),t),o(n(73),t),o(n(806),t),o(n(4028),t),o(n(93),t),o(n(9681),t),o(n(8110),t),o(n(3049),t)},5069:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},5643:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.LocationAuthorizationStatus=void 0,(n=t.LocationAuthorizationStatus||(t.LocationAuthorizationStatus={}))[n.notDetermined=0]="notDetermined",n[n.restricted=1]="restricted",n[n.denied=2]="denied",n[n.authorized=3]="authorized",n[n.authorizedWhenInUse=4]="authorizedWhenInUse"},6091:(e,t)=>{function n(){let e=!1;return"iOS"===host.platform?e=host.isOSAtLeast(16,0,0):"macOS"===host.platform?e=host.isOSAtLeast(13,0,0):"tvOS"===host.platform?e=host.isOSAtLeast(16,0,0):"watchOS"===host.platform&&(e=host.isOSAtLeast(9,0,0)),e}Object.defineProperty(t,"__esModule",{value:!0}),t.logInfo=t.logError=t.logDebug=t.logDefault=void 0,t.logDefault=function(e){AMS.log.default(e)},t.logDebug=function(e){n()?AMS.log.debug(e):AMS.log.default(e)},t.logError=function(e){AMS.log.error(e)},t.logInfo=function(e){n()?AMS.log.info(e):AMS.log.default(e)}},721:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.MediaType=void 0,(n=t.MediaType||(t.MediaType={}))[n.app=0]="app",n[n.appBundle=1]="appBundle",n[n.inApp=2]="inApp",n[n.arcadeApp=3]="arcadeApp",n[n.appRecommendation=4]="appRecommendation",n[n.audioBook=100]="audioBook",n[n.book=101]="book",n[n.bookSeries=102]="bookSeries",n[n.album=200]="album",n[n.musicVideo=201]="musicVideo",n[n.playlist=202]="playlist",n[n.song=203]="song",n[n.station=204]="station",n[n.podcast=300]="podcast",n[n.podcastEpisode=301]="podcastEpisode"},73:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.enqueue=void 0,t.enqueue=function(e){AMS.metrics.enqueue(e.topic,{...e.fields,clientOnlyProperties:{checkDU:e.checkDU,suppressEngagement:!0}},{personalized:e.personalized})}},806:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},4028:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},93:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.ServerDataCacheNetworkPolicy=void 0,(n=t.ServerDataCacheNetworkPolicy||(t.ServerDataCacheNetworkPolicy={}))[n.returnCachedDataDontLoad=0]="returnCachedDataDontLoad",n[n.returnValidCachedDataDontLoad=1]="returnValidCachedDataDontLoad",n[n.returnCachedDataElseLoadFallbackCached=2]="returnCachedDataElseLoadFallbackCached",n[n.returnCachedDataElseLoadFallbackNone=3]="returnCachedDataElseLoadFallbackNone"},9681:(e,t)=>{var n,r,o,i;Object.defineProperty(t,"__esModule",{value:!0}),t.lookUpSubscriptionStatus=t.SubscriptionResponseCarrierStatus=t.SubscriptionResponseStatus=t.SubscriptionResponseSource=t.SubscriptionMediaType=void 0,function(e){e[e.activity=0]="activity",e[e.appStore=1]="appStore",e[e.music=2]="music",e[e.news=3]="news",e[e.tv=4]="tv",e[e.icloud=5]="icloud",e[e.podcast=6]="podcast"}(n=t.SubscriptionMediaType||(t.SubscriptionMediaType={})),(i=t.SubscriptionResponseSource||(t.SubscriptionResponseSource={}))[i.unknown=0]="unknown",i[i.apple=1]="apple",i[i.carrier=2]="carrier",function(e){e[e.notEntitled=0]="notEntitled",e[e.entitled=1]="entitled"}(r=t.SubscriptionResponseStatus||(t.SubscriptionResponseStatus={})),(o=t.SubscriptionResponseCarrierStatus||(t.SubscriptionResponseCarrierStatus={}))[o.unknown=0]="unknown",o[o.eligible=1]="eligible",o[o.notEligible=2]="notEligible",o[o.requiresVerification=3]="requiresVerification",o[o.unlinked=4]="unlinked",t.lookUpSubscriptionStatus=async function(e){let t=await AMS.subscription.lookup(e),o=!1;if(e.type!==n.music)switch(AMS.log.debug("Attempting to correct subscription entitlement status"),host.platform){case"iOS":case"tvOS":o=!host.isOSAtLeast(16,3,0);break;case"macOS":o=!host.isOSAtLeast(13,2,0);break;case"watchOS":o=!host.isOSAtLeast(9,3,0)}return o&&(t=function(e){const t=e;return Object.keys(t.entitlements).forEach((e=>{const n=t.entitlements[e],o=new Date(0);o.setUTCSeconds(n.expiration),o<new Date&&(n.status=r.notEntitled)})),t}(t)),t}},8110:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.Bucket=void 0,(n=t.Bucket||(t.Bucket={}))[n.explicit=-1]="explicit",n[n.implicit=-2]="implicit"},3049:(e,t)=>{var n,r,o,i,a,c;Object.defineProperty(t,"__esModule",{value:!0}),t.ShowPreviewsSetting=t.NotificationSetting=t.NotificationGroupingSetting=t.ExplicitContentSetting=t.AuthorizationStatus=t.AlertStyle=void 0,(c=t.AlertStyle||(t.AlertStyle={}))[c.none=0]="none",c[c.banner=1]="banner",c[c.alert=2]="alert",(a=t.AuthorizationStatus||(t.AuthorizationStatus={}))[a.notDetermined=0]="notDetermined",a[a.denied=1]="denied",a[a.authorized=2]="authorized",a[a.provisional=3]="provisional",a[a.ephemeral=4]="ephemeral",(i=t.ExplicitContentSetting||(t.ExplicitContentSetting={}))[i.unknown=-1]="unknown",i[i.disabled=0]="disabled",i[i.enabled=1]="enabled",(o=t.NotificationGroupingSetting||(t.NotificationGroupingSetting={}))[o.default=0]="default",o[o.source=1]="source",o[o.off=2]="off",(r=t.NotificationSetting||(t.NotificationSetting={}))[r.notSupported=0]="notSupported",r[r.disabled=1]="disabled",r[r.enabled=2]="enabled",(n=t.ShowPreviewsSetting||(t.ShowPreviewsSetting={}))[n.always=0]="always",n[n.whenAuthenticated=1]="whenAuthenticated",n[n.never=2]="never"},9615:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.EventComponents=void 0,(n=t.EventComponents||(t.EventComponents={}))[n.none=0]="none",n[n.app=1]="app",n[n.backlog=2]="backlog",n[n.all=3]="all"},6307:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.map=void 0;const r=n(4944);t.map=function(e,t){var n;return null===(n=r.mappers[t])||void 0===n?void 0:n.call(r.mappers,e)}},9869:function(e,t,n){var r,o=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||o(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),t.inplace=void 0,r=n(220),Object.defineProperty(t,"inplace",{enumerable:!0,get:function(){return r.inplace}}),i(n(4944),t),i(n(6307),t)},6961:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.click=t.tabVisit=t.enter=t.bundleId=t.download=t.play=t.enterFromMarketingCommunication=void 0,t.enterFromMarketingCommunication={instrumentation:{eventType:"page",pageUrl:"%itscg=%"},map:{ARCADE_mapEnterFromMarketingCommunication:1}},t.play={instrumentation:{eventType:"playActivity|launches",duration:">60",topic:"xp_amp_app_usage_arcade"},map:{eventType:"play"}},t.download={instrumentation:{eventType:"click",actionDetails:{buyParams:"{__toLower__}%pricingparameters=game%"},topic:"xp_amp_appstore"},map:{eventType:"arcadeDownload",contentType:1}},t.bundleId={instrumentation:{eventType:"purchase",buyParameters:{bid:"com.apple.AppStore"}},map:{bundleId:"com.apple.AppStore"}},t.enter={instrumentation:{topic:"xp_amp_appstore",eventType:"page",pageContext:"{__toLower__}~arcade|{__undefined__}"},map:{eventType:"enter"}},t.tabVisit={instrumentation:{topic:"xp_amp_appstore",eventType:"page",pageContext:"{__toLower__}arcade"},map:{eventType:"tabVisited",tabType:4}},t.click={instrumentation:{eventType:"click",actionType:"buy",actionContext:"Arcade",targetType:"button"},map:{ARCADE_mapClick:1}}},2284:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.extractItscg=void 0,t.extractItscg=function(e){var t;const n=null===(t=/&itscg=(.*)&/.exec(e))||void 0===t?void 0:t.filter((e=>!e.includes("&itscg=")));return null==n?void 0:n[0]}},7401:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){var t,n;if(e&&e.__esModule)return e;if(t={},null!=e)for(n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.TvMappers=t.ArcadeUtils=t.ArcadeMappers=void 0,t.ArcadeMappers=i(n(6961)),t.ArcadeUtils=i(n(2284)),t.TvMappers=i(n(2157))},2157:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.sportsFavorite=t.download=t.tabVisit=t.addToUpNext=t.enter=t.tvPlay=t.tvPlusPlay=void 0,t.tvPlusPlay={instrumentation:{eventType:"playActivity",actionType:"start",brandId:"tvs.sbd.4000",programmingType:"videoOnDemand",topic:"xp_amp_tv_vpaf"},map:{eventType:"tvPlusPlay"}},t.tvPlay={instrumentation:{eventType:"media",topic:"xp_amp_tv_main",actionType:"{__toLower__}play|{__toLower__}punchout|{__null__}|{__undefined__}",contentType:"movie|episode|homevideo|show|movierental|liveservice|sportingevent|library|season|{__null__}|{__undefined__}"},map:{eventType:"play"}},t.enter={instrumentation:{eventType:"page|account",topic:"xp_amp_tv_main"},map:{eventType:"enter"}},t.addToUpNext={instrumentation:{eventType:"click",actionType:"add",topic:"xp_amp_tv_main",targetType:"{__toLower__}%button%"},map:{eventType:"addToUpNext"}},t.tabVisit={instrumentation:{eventType:"page",topic:"xp_amp_tv_main",pageContext:"{__toLower__}originals"},map:{eventType:"tabVisited",tabType:2}},t.download={instrumentation:{eventType:"click",topic:"xp_amp_tv_main",actionType:"{__toLower__}download"},map:{eventType:"download",contentType:2}},t.sportsFavorite={instrumentation:{eventType:"click",topic:"xp_amp_tv_main",actionType:"{__toLower__}add",targetType:"{__toLower__}sportsleague",dialogType:"{__toLower__}sportsfavorites"},map:{eventType:"sportsFavorite"}}},5577:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.non=void 0,t.non=function(e){return t=>t!==e}},220:function(e,t,n){var r,o=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){var t,n;if(e&&e.__esModule)return e;if(t={},null!=e)for(n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.types=t.reducers=t.mappers=t.filters=t.inplace=t.map=void 0,r=n(8136),Object.defineProperty(t,"map",{enumerable:!0,get:function(){return r.map}}),Object.defineProperty(t,"inplace",{enumerable:!0,get:function(){return r.inplace}}),t.filters=a(n(5577)),t.mappers=a(n(9534)),t.reducers=a(n(8272)),t.types=a(n(2175))},8136:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){var t,n;if(e&&e.__esModule)return e;if(t={},null!=e)for(n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.map=t.inplace=void 0;const a=n(9534),c=i(n(4308));t.inplace=function(e){return t=>{const n=e(t);c.equals(t)(n)||Object.assign(t,n)}},t.map=function(e){return t=>{switch((0,a.isInstrumentedEvent)(t)(e.instrumentation)){case!0:return{...t,...e.map};case!1:return t}}}},9534:function(e,t,n){function r(e){return t=>{const n=function(e){return t=>n=>n.split(h.OR).map(r(e)(t)).reduce(p.or)}(e)(t),l=function(e){return t=>n=>n.split(h.AND).map(r(e)(t)).reduce(p.and)}(e)(t),f=function(e){return t=>n=>{const o=s(n)(h.NOT);return!r(e)(t)(o)}}(e)(t),d=function(e){return t=>n=>{return(o=n,e=>{const t=(n=o,e=>{const[t]=Object.keys(e).filter((e=>n.includes(e)));return t})(m.transforms);var n;const i=function(e){return t=>s(t)(e)}(t)(o),a=m.transforms[t];return t=>r(a(t))(e)(i)})(t)(e);var o}}(e)(t),y=function(e){return t=>{if(!(0,b.isString)(e))return!1;switch(!0){case a(r=t)&&c(r):return e.includes((n=h.WILDCARD,e=>{const[t]=[e].map(o(n)).map(i(n));return t})(t));case a(t):return e.endsWith(o(h.WILDCARD)(t));default:return e.startsWith(i(h.WILDCARD)(t))}var n,r}}(e),g=function(e){return t=>n=>{const[r,o]=function(e){const[t,...n]=e.split("");return[t,n.join("").trim()]}(n),i=o.startsWith(h.COMPUTE)?function(e){return t=>{const n=s(t)(h.COMPUTE,h.OPEN_PARENTHESIS,h.CLOSE_PARENTHESIS),r=function(e){const[t]=["+","-","*","/"].filter((t=>e.includes(t)));return(0,b.isComputeOperator)(t)?t:void 0}(n);if((0,b.isUndefined)(r))return;const[o,i]=function(e){return t=>n=>{const[r,o]=e.split(n).map((e=>e.trim()));return[u(r)(t),u(o)(t)]}}(n)(e)(r);switch(r){case"*":return o*i;case"/":return o/i;case"+":return o+i;case"-":return o-i}}}(t)(o):Number(o);var a;return(a=Number(e),e=>t=>{if((0,b.isUndefined)(t))return!1;switch(e){case">":return a>t;case"<":return a<t}})(r)(i)}}(e)(t);return t=>{switch(!0){case t.includes(h.OR):return n(t);case t.includes(h.AND):return l(t);case t.startsWith("~"):return f(t);case r=t,Object.keys(m.transforms).map((e=>r.includes(e))).reduce(p.or):return d(t);case function(e){return a(e)||c(e)}(t):return y(t);case function(e){return e.startsWith(">")||e.startsWith("<")}(t):return g(t);default:return v.equals(e)(t)}var r}}}function o(e){return t=>{const n=new RegExp(`^${e}+`);return t.replace(n,"")}}function i(e){return t=>{const n=new RegExp(`${e}+`);return t.replace(n,"")}}function a(e){return e.startsWith(h.WILDCARD)}function c(e){return e.endsWith(h.WILDCARD)}function s(e){return(...t)=>{const[n]=t;return(0,b.isUndefined)(n)?e:s(e.replace(n,""))(...t.slice(1)).trim()}}function u(e){return t=>{if(e.startsWith(h.FIELD)){const n=s(e)(h.FIELD);return Number(t[n])}return Number(e)}}var l=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),f=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),d=this&&this.__importStar||function(e){var t,n;if(e&&e.__esModule)return e;if(t={},null!=e)for(n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&l(t,e,n);return f(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.isInstrumentedEvent=void 0;const p=n(8272),v=d(n(4308)),h=d(n(1941)),m=n(6988),b=n(1092);t.isInstrumentedEvent=function e(t){return n=>Object.entries(n).map(function(t){return([n,o])=>{const i=(a=t[n],(0,b.isUndefined)(a)?h.UNDEFINED:(0,b.isNull)(a)?h.NULL:a);var a;switch(typeof o){case"string":return r(i)(t)(o);case"number":case"boolean":return function(e){return t=>v.equals(e)(t)}(i)(o);case"object":return function(t){return n=>Array.isArray(n)&&Array.isArray(t)?function(e){return t=>{const[n,...r]=t;return 0===r.length&&v.includes(e)(n)}}(t)(n):!!(0,b.isPlainObject)(n)&&e(t)(n)}(i)(o)}}}(t)).reduce(p.and)}},6988:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.transforms=void 0;const r=n(1092);t.transforms={"{__toLower__}":function(e){return(0,r.isString)(e)?e.toLowerCase():void 0}}},1092:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isComputeOperator=t.isString=t.isNull=t.isUndefined=t.isPlainObject=void 0;const r=n(4308);t.isPlainObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},t.isUndefined=function(e){return(0,r.equals)(e)(void 0)},t.isNull=function(e){return(0,r.equals)(e)(null)},t.isString=function(e){return(0,r.equals)(typeof e)("string")},t.isComputeOperator=function(e){return["+","-","*","/"].includes(e)}},8272:(e,t)=>{function n(e,t){return e&&t}Object.defineProperty(t,"__esModule",{value:!0}),t.all=t.sum=t.or=t.and=void 0,t.and=n,t.or=function(e,t){return e||t},t.sum=function(e,t){return e+t},t.all=function(e){return Boolean(e.reduce(n,!0))}},1941:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.OR=t.AND=t.WILDCARD=t.NOT=t.CLOSE_PARENTHESIS=t.OPEN_PARENTHESIS=t.NULL=t.UNDEFINED=t.COMPUTE=t.FIELD=void 0,t.FIELD="{__field__}",t.COMPUTE="{__compute__}",t.UNDEFINED="{__undefined__}",t.NULL="{__null__}",t.OPEN_PARENTHESIS="(",t.CLOSE_PARENTHESIS=")",t.NOT="~",t.WILDCARD="%",t.AND="^",t.OR="|"},2175:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},4308:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),o(n(3831),t)},3831:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.includes=t.choose=t.equals=void 0,t.equals=function(e){return t=>e===t},t.choose=function(e,t){return t||e},t.includes=function(e){return t=>e.includes(t)}},790:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){var t,n;if(e&&e.__esModule)return e;if(t={},null!=e)for(n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.mappers=void 0,t.mappers=i(n(9994))},9994:(e,t,n)=>{function r(e){return(0,s.map)(u.ArcadeMappers.enter)(e)}function o(e){return(0,s.map)(u.ArcadeMappers.tabVisit)(e)}function i(e){return(0,s.map)(u.ArcadeMappers.bundleId)(e)}function a(e){return(0,s.map)(u.ArcadeMappers.play)(e)}function c(e){return(0,s.map)(u.ArcadeMappers.download)(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.ARCADE_mapItscg=t.ARCADE_mapClick=t.ARCADE_mapEnterFromMarketingCommunication=t.ARCADE_mapDownload=t.ARCADE_mapPlay=t.ARCADE_mapBundleId=t.ARCADE_mapTabVisit=t.ARCADE_mapEnter=t.ARCADE_odj=void 0;const s=n(220),u=n(7401),l=n(4308),f=n(1092);t.ARCADE_odj=function(e){return(0,s.inplace)(i)(e),[r,o,c,a].map((t=>t(e))).filter((t=>!(0,l.equals)(t)(e)))},t.ARCADE_mapEnter=r,t.ARCADE_mapTabVisit=o,t.ARCADE_mapBundleId=i,t.ARCADE_mapPlay=a,t.ARCADE_mapDownload=c,t.ARCADE_mapEnterFromMarketingCommunication=function(e){return(0,s.map)(u.ArcadeMappers.enterFromMarketingCommunication)(e)},t.ARCADE_mapClick=function(e){return(0,s.map)(u.ArcadeMappers.click)(e)},t.ARCADE_mapItscg=function(e){const t=e.pageUrl,n=t&&u.ArcadeUtils.extractItscg(t);return{...e,ARCADE_mapItscg:(0,f.isUndefined)(n)?null:n}}},4944:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){var t,n;if(e&&e.__esModule)return e;if(t={},null!=e)for(n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.mappers=t.tv=t.arcade=void 0;const a=n(790);t.arcade=i(n(790)),t.tv=i(n(5914)),t.mappers={...a.mappers}},5914:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){var t,n;if(e&&e.__esModule)return e;if(t={},null!=e)for(n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.mappers=void 0,t.mappers=i(n(3331))},3331:(e,t,n)=>{function r(e){return(0,l.map)(f.TvMappers.tvPlusPlay)(e)}function o(e){return(0,l.map)(f.TvMappers.tvPlay)(e)}function i(e){return(0,l.map)(f.TvMappers.enter)(e)}function a(e){return(0,l.map)(f.TvMappers.addToUpNext)(e)}function c(e){return(0,l.map)(f.TvMappers.tabVisit)(e)}function s(e){return(0,l.map)(f.TvMappers.download)(e)}function u(e){return(0,l.map)(f.TvMappers.sportsFavorite)(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.TV_mapSportsFavorite=t.TV_mapDownload=t.TV_mapTabVisit=t.TV_mapAddToUpNext=t.TV_mapTvEnter=t.TV_mapTvPlay=t.TV_mapTvPlusPlay=t.TV_odj=void 0;const l=n(220),f=n(7401),d=n(4308);t.TV_odj=function(e){return[r,o,i,a,c,s,u].map((t=>t(e))).filter((t=>!(0,d.equals)(t)(e)))},t.TV_mapTvPlusPlay=r,t.TV_mapTvPlay=o,t.TV_mapTvEnter=i,t.TV_mapAddToUpNext=a,t.TV_mapTabVisit=c,t.TV_mapDownload=s,t.TV_mapSportsFavorite=u},5886:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.reduce=t.map=void 0;const r=n(9246),o=n(5561);t.map=function(e,t){var n;return null===(n=r.mappers[t])||void 0===n?void 0:n.call(r.mappers,e)},t.reduce=function(e,t){var n;return null===(n=o.reducers[t])||void 0===n?void 0:n.call(o.reducers,e)}},8950:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),o(n(5886),t)},8587:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){var t,n;if(e&&e.__esModule)return e;if(t={},null!=e)for(n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.ArcadeReducers=void 0,t.ArcadeReducers=i(n(1194))},1194:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.itscg=void 0,t.itscg={operations:{ARCADE_mapItscg:"compactAppend"},aliases:{ARCADE_mapItscg:"itscg_in_last_7_days"}}},268:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.reduce=void 0;var r=n(6347);Object.defineProperty(t,"reduce",{enumerable:!0,get:function(){return r.reduce}})},6347:(e,t)=>{function n(e){return t=>{const n=function(e){return t=>i(e.operations).map(function(e){return t=>e.map((e=>e[t]))}(t))}(e)(t),r=function(e){const t=e.operations,n=i(t);return e=>e.map(((e,r)=>{const o=p(e);return(i=t[n[r]],e=>{switch(i){case"sum":return function(e){return u(e,c)?e.reduce(d,0):0}(e);case"append":return e;case"compactAppend":return function(e){return e.filter((e=>e))}(e)}})(o);var i}))}(e)(n);return o(function(e){return i(e.operations).map((t=>{var n;return(null===(n=e.aliases)||void 0===n?void 0:n[t])||t}))}(e))(r)}}function r(e){return t=>{const r=e.groupby,i=function(e){return t=>{const n=t.map((t=>t[e])).filter(v(void 0));return Array.from(new Set(n))}}(r)(t);if(u(i,c)||u(i,s)){const c=i.map((a=r,e=>t=>e.filter((e=>l(e[a])(t))))(t)),s=c.map(n(e));return o(i)(s)}var a;return n(e)(t)}}function o(e){return t=>{const n=t.map(((t,n)=>{return(r=e[n],e=>a(r)?{}:{[r]:e})(t);var r}));return Object.assign({},...n)}}function i(e){return Object.keys(e)}function a(e){return l(e)(void 0)}function c(e){return l(typeof e)("number")}function s(e){return l(typeof e)("string")}function u(e,t){return Boolean(e.map(t).reduce(f,!0))}function l(e){return t=>e===t}function f(e,t){return e&&t}function d(e,t){return e+t}function p(e){return e.filter(v(void 0))}function v(e){return t=>t!==e}Object.defineProperty(t,"__esModule",{value:!0}),t.compact=t.and=t.equals=t.reduce=void 0,t.reduce=function(e){return t=>(a(e.groupby)?n:r)(e)(t)},t.equals=l,t.and=f,t.compact=p},9246:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),o(n(9869),t)},3129:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){var t,n;if(e&&e.__esModule)return e;if(t={},null!=e)for(n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.reducers=void 0,t.reducers=i(n(5230))},5230:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ARCADE_reduceItscg=void 0;const r=n(9994),o=n(268),i=n(6829),a=n(8587);t.ARCADE_reduceItscg=function(e){const t=e.map(r.ARCADE_mapEnterFromMarketingCommunication).map(r.ARCADE_mapItscg),n=(0,o.reduce)(a.ArcadeReducers.itscg)(t);return(0,i.packToObject)("ARCADE_reduceItscg")(n)}},5561:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.reducers=void 0;var r=n(3129);Object.defineProperty(t,"reducers",{enumerable:!0,get:function(){return r.reducers}})},6829:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.packToObject=void 0,t.packToObject=function(e){return t=>({[e]:t})}},9100:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),o(n(4908),t)},4908:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.inject=t.ObjectGraph=void 0;const r=n(2450);t.ObjectGraph=class{constructor(e){this._members={},this.name=e}adding(e,t){const n=this.clone();return n._members[e.name]=t,n}removing(e){const t=this.clone();return delete t._members[e.name],t}optional(e){return this._members[e.name]}required(e){const t=this._members[e.name];if(r.isNothing(t)){const t=Object.keys(this._members).sort().join(", ");throw new Error(`No member with type ${e.name} found in ${this.name}. Candidates ${t}`)}return t}clone(){const e=new(0,this.constructor)(this.name);for(const[t,n]of Object.entries(this._members))e._members[t]=n;return e}},t.inject=function(e,t){return t.required(e)}},5542:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),o(n(1721),t),o(n(9031),t),o(n(1662),t),o(n(2024),t),o(n(2450),t)},6418:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.valueAsNumber=t.valueAsString=t.valueAsBoolean=void 0;const r=n(2450),o=n(4172);t.valueAsBoolean=function(e,t="coercible",n){if(!r.isSome(e))return e;if("boolean"==typeof e)return e;if("string"==typeof e){if("true"===e)return!0;if("false"===e)return!1}const i=Boolean(e);switch(t){case"strict":o.context("asBoolean",(()=>{o.unexpectedType("coercedValue","boolean",e,n)}));break;case"coercible":if(r.isNothing(i))return o.context("asBoolean",(()=>{o.unexpectedType("coercedValue","boolean",e,n)})),null}return i},t.valueAsString=function(e,t="coercible",n){if(!r.isSome(e))return e;if("string"==typeof e)return e;const i="object"==typeof e?null:String(e);switch(t){case"strict":o.context("asString",(()=>{o.unexpectedType("coercedValue","string",e,n)}));break;case"coercible":r.isNothing(i)&&o.context("asString",(()=>{o.unexpectedType("coercedValue","string",e,n)}))}return i},t.valueAsNumber=function(e,t="coercible",n){if(!r.isSome(e))return e;if("number"==typeof e)return e;const i=Number(e);switch(t){case"strict":o.context("asNumber",(()=>{o.unexpectedType("coercedValue","number",e,n)}));break;case"coercible":if(isNaN(i))return o.context("asNumber",(()=>{o.unexpectedType("coercedValue","number",e,n)})),null}return i}},1077:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),o(n(4409),t)},2506:(e,t,n)=>{function r(e){if(Array.isArray(e))return e;switch(typeof e){case"string":{const t=i[e];if(o.isSome(t))return t;{const t=Object.freeze(e.split("."));return i[e]=t,t}}case"number":case"symbol":return[e];default:throw new TypeError(`${e} is not a KeyPath`)}}Object.defineProperty(t,"__esModule",{value:!0}),t.keyPathContains=t.keyPathEndsWith=t.keyPathStartsWith=t.keyPathsEqual=t.isKeyPathThis=t.thisKeyPath=t.keysOf=void 0;const o=n(2450),i={};t.keysOf=r,t.thisKeyPath=Object.freeze([]),t.isKeyPathThis=function(e){return Array.isArray(e)&&0===e.length},t.keyPathsEqual=function(e,t){if(e===t)return!0;const n=r(e),o=r(t);if(n.length!==o.length)return!1;for(let e=0,t=n.length;e<t;e+=1)if(n[e]!==o[e])return!1;return!0},t.keyPathStartsWith=function(e,t){if(e===t)return!0;{const n=r(e);return 0!==n.length&&n[0]===t}},t.keyPathEndsWith=function(e,t){if(e===t)return!0;{const n=r(e);return 0!==n.length&&n[n.length-1]===t}},t.keyPathContains=function(e,t){return e===t||r(e).includes(t)}},6853:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ObjectCursor=void 0;const r=n(2450),o=n(2879),i=n(2506),a=n(7454);t.ObjectCursor=class{constructor(e){this.values=[e],this.keyPaths=[i.thisKeyPath],this.savedDepths=[]}get currentValue(){return this.values[this.values.length-1]}get currentKeyPath(){return this.keyPaths[this.keyPaths.length-1]}interject(e,t){this.values.push(e),this.keyPaths.push(t)}reuse(e,t=i.thisKeyPath){this.values.length=0,this.values.push(e),this.keyPaths.length=0,this.keyPaths.push(t),this.savedDepths.length=0}moveTo(e){const t=a.traverse(this.currentValue,e);return this.values.push(t),this.keyPaths.push(e),t}moveBack(){const e=this.values.length;if(1===e)throw new Error("Cannot move back past the root of a cursor");const t=this.savedDepths.length;if(t>0&&e<=this.savedDepths[t-1])throw new Error("Cannot move back past the most recent saved state");this.values.pop(),this.keyPaths.pop()}saveState(){this.savedDepths.push(this.values.length)}restoreState(){const e=this.savedDepths.pop();if(r.isNothing(e))throw new Error("Calls to restoreState must balance previous calls to saveState");this.values.length=e,this.keyPaths.length=e}clone(){const e=o.shallowCloneOf(this);return e.values=this.values.slice(),e.keyPaths=this.keyPaths.slice(),e.savedDepths=this.savedDepths.slice(),e}}},4409:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ObjectReader=void 0;const r=n(2450),o=n(2879),i=n(6418),a=n(2506),c=n(6853),s=n(7454),u=new Map;class l{constructor(e){this._cursor=new c.ObjectCursor(e)}get currentKeyPath(){return this._cursor.currentKeyPath}has(e){return a.keyPathEndsWith(this._cursor.currentKeyPath,e)||r.isSome(this.get(e))}select(e,t=!1){return!t&&a.keyPathsEqual(this._cursor.currentKeyPath,e)||this._cursor.moveTo(e),this}deselect(){return this._cursor.moveBack(),this}saveSelection(){return this._cursor.saveState(),this}restoreSelection(){return this._cursor.restoreState(),this}get(e=a.thisKeyPath){return a.isKeyPathThis(e)?this._cursor.currentValue:s.traverse(this._cursor.currentValue,e)}asBoolean(e=a.thisKeyPath,t="coercible"){return i.valueAsBoolean(this.get(e),t,String(e))}asNumber(e=a.thisKeyPath,t="coercible"){return i.valueAsNumber(this.get(e),t,String(e))}asString(e=a.thisKeyPath,t="coercible"){return i.valueAsString(this.get(e),t,String(e))}*[Symbol.iterator](){const e=this.get();if(r.isNothing(e))return;const t=l._clone(this);if(Array.isArray(e)){let n=0;for(const r of e)t.saveSelection(),t._cursor.interject(r,n),yield t,t.restoreSelection(),n+=1}else yield t;l._recycle(t)}reduce(e,t){const n=this.get();if(r.isNothing(n))return e;if(!Array.isArray(n))return t(e,this);try{let r=e;for(let e=0,o=n.length;e<o;e+=1)this.saveSelection(),this._cursor.interject(n[e],e),r=t(r,this),this.restoreSelection();return r}catch(e){throw this.restoreSelection(),e}}map(e){return this.reduce(new Array,((t,n)=>(t.push(e(n)),t)))}compactMap(e){return this.reduce(new Array,((t,n)=>{const o=e(n);return r.isSome(o)&&t.push(o),t}))}applyTo(e,...t){this.saveSelection();try{const n=e(this,...t);return this.restoreSelection(),n}catch(e){throw this.restoreSelection(),e}}callOn(e,t,...n){this.saveSelection();try{const r=e.call(t,this,...n);return this.restoreSelection(),r}catch(e){throw this.restoreSelection(),e}}clone(){const e=o.shallowCloneOf(this);return e._cursor=this._cursor.clone(),e}static optimizeIterationUpToDepth(e){for(let t=0;t<e;t+=1)l._recycle(new l(void 0))}static _clone(e){const t=u.get(e.constructor);if(r.isSome(t)){const n=t.pop();if(r.isSome(n))return n.onReuseToIterate(e),n}return e.clone()}onReuseToIterate(e){const t=e._cursor;this._cursor.reuse(t.currentValue,t.currentKeyPath)}static _recycle(e){const t=e.constructor,n=u.get(t);if(r.isSome(n)){if(n.length>=5)return;e.onRecycleForIteration(),n.push(e)}else e.onRecycleForIteration(),u.set(t,[e])}onRecycleForIteration(){this._cursor.reuse(void 0)}}t.ObjectReader=l},7454:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.traverse=void 0;const r=n(2450),o=n(2506);t.traverse=function(e,t){if("object"!=typeof e)return e;if(!r.isSome(e))return e;const n=o.keysOf(t);switch(n.length){case 0:return e;case 1:return e[n[0]];default:let t=e;for(const e of n){const n=t[e];if("object"!=typeof n)return n;if(!r.isSome(n))return n;t=n}return t}}},4172:(e,t,n)=>{function r(e){return Array.isArray(e)?"array":null===e?"null":typeof e}function o(e,t,n,o){l({type:"badType",expected:t,actual:`${r(n)} (${n})`,objectPath:f.isSome(o)&&o.length>0?o:"<this>",contextNames:c(),recoveryAction:e,stack:(new Error).stack})}function i(e){return!f.isNothing(e)&&(e.hasOwnProperty("$incidents")||Object.isExtensible(e))}function a(e){d.nameStack.push(e)}function c(){return 0===d.nameStack.length?["<empty stack>"]:d.nameStack.slice(0)}function s(){d.nameStack.length,d.nameStack.pop()}function u(e,t,n){let r=null;f.isSome(n)&&n.length>0&&(r=e,d.suppressedIncidentPaths.push(n));let i=null;try{a(e),i=t()}catch(e){throw e.hasThrown||(o("defaultValue","no exception",e.message),e.hasThrown=!0),e}finally{e===r&&d.suppressedIncidentPaths.pop(),s()}return i}function l(e){-1===d.suppressedIncidentPaths.indexOf(e.objectPath)&&d.incidents.push(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.unexpectedNull=t.catchingContext=t.context=t.recordValidationIncidents=t.endContext=t.getContextNames=t.beginContext=t.messageForRecoveryAction=t.isValidatable=t.unexpectedType=t.extendedTypeof=void 0;const f=n(2450);t.extendedTypeof=r,t.unexpectedType=o,t.isValidatable=i,t.messageForRecoveryAction=function(e){switch(e){case"coercedValue":return"Coerced format";case"defaultValue":return"Default value used";case"ignoredValue":return"Ignored value";default:return"Unknown"}};const d={nameStack:Array(),incidents:Array(),suppressedIncidentPaths:Array()};t.beginContext=a,t.getContextNames=c,t.endContext=s,t.recordValidationIncidents=function(e){i(e)&&(e.$incidents=d.incidents),d.incidents=[],d.nameStack=[],d.suppressedIncidentPaths=[]},t.context=u,t.catchingContext=function(e,t,n){let r=null;try{r=u(e,t)}catch(e){r=null,f.isSome(n)&&(r=n(e))}return r},t.unexpectedNull=function(e,t,n){l({type:"nullValue",expected:t,actual:"null",objectPath:f.isSome(n)&&n.length>0?n:"<this>",contextNames:c(),recoveryAction:e,stack:(new Error).stack})}},8535:(e,t,n)=>{t.B=void 0;const r=n(4409),o=n(2450),i=n(7771);t.B=class{constructor(e){this.options=Object.freeze(e)}get defaultTopic(){return this.options.defaultTopic}applyDeResolutionRules(e,t){const n=new r.ObjectReader(e);for(const r of t){const t=n.asNumber(r.fieldName);if(o.isNothing(t))continue;let a=r.magnitude;o.isNothing(a)&&(a=1048576);let c=r.significantDigits;if(o.isNothing(c)&&(c=2),a<=0||c<0){e[r.fieldName]=Number.NaN;continue}const s=t/a;e[r.fieldName]=i.reduceSignificantDigits(s,c)}}decorateCommonEventFields(e,t){const n=new r.ObjectReader(e),i=this.options.configuration,a=i.baseFields(t);o.isSome(a)&&Object.assign(e,a),e.clientBuildType=this.options.environment.buildType,e.resourceRevNum=this.options.environment.jsVersion,e.xpSendMethod="jet-js";const c=n.asString("pageType"),s=n.asString("pageId");if(o.isSome(c)&&o.isSome(s)){const n=i.compoundSeparator(t),r=o.isSome(n)?o.unwrapOptional(n):"_";e.page=`${c}${r}${s}`}const u=i.deResolutionRules(t);this.applyDeResolutionRules(e,u)}decorateMediaEventEvents(e){const t=new r.ObjectReader(e).asNumber("position");o.isSome(t)&&(e.position=Math.round(t))}lint(e,t={}){const n=new r.ObjectReader(e),i=n.asString("eventType");this.options.isLoggingEnabled;const a=JSON.parse(JSON.stringify(e)),c=n.asString("topic"),s=o.isSome(c)?o.unwrapOptional(c):this.options.defaultTopic;this.decorateCommonEventFields(a,s),"media"===i&&this.decorateMediaEventEvents(a);for(const e of this.options.rules)e.apply(a,t);return{fields:a}}}},7771:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.reduceSignificantDigits=void 0,t.reduceSignificantDigits=function(e,t){const n=Math.pow(10,t);return(e>0?Math.floor:Math.ceil)(e/n)*n}},1219:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},8045:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},9891:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},1121:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},1721:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),"undefined"==typeof preprocessor&&(globalThis.preprocessor={PRODUCTION_BUILD:!1,CARRY_BUILD:!1,DEBUG_BUILD:!1,INTERNAL_BUILD:!1}),"undefined"==typeof testContent&&(globalThis.testContent={INCLUDE_TEST_CONTENT:!1}),o(n(1219),t),o(n(8045),t),o(n(9891),t),o(n(1121),t),o(n(3907),t),o(n(6534),t),o(n(5817),t),o(n(3043),t),o(n(5037),t),o(n(5937),t),o(n(1222),t)},3907:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},6534:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},5817:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},3043:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},5037:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},5937:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},1222:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.services=t.random=t.plist=t.platform=t.net=t.localizer=t.host=t.cryptography=t.bundle=t.bag=void 0;const r=n(900);t.bag=r.makeMetatype("jet-engine:bag"),t.bundle=r.makeMetatype("jet-engine:bundle"),t.cryptography=r.makeMetatype("jet-engine:cryptography"),t.host=r.makeMetatype("jet-engine:host"),t.localizer=r.makeMetatype("jet-engine:localizer"),t.net=r.makeMetatype("jet-engine:net"),t.platform=r.makeMetatype("jet-engine:platform"),t.plist=r.makeMetatype("jet-engine:plist"),t.random=r.makeMetatype("jet-engine:random"),t.services=r.makeMetatype("jet-engine:services")},2490:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},9031:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),o(n(2490),t)},1662:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.notInstrumented=t.PageInvocationPoint=t.EMPTY_LINTED_METRICS_EVENT=void 0,t.EMPTY_LINTED_METRICS_EVENT={fields:{},issues:[]},(n=t.PageInvocationPoint||(t.PageInvocationPoint={})).pageEnter="pageEnter",n.pageExit="pageExit",n.appExit="appExit",n.appEnter="appEnter",n.backButton="backButton",t.notInstrumented=function(e){switch(e){case 0:return{data:[],custom:{}};case 1:default:return{};case 2:return{instructions:[],custom:{}};case 3:return{id:{id:"",impressionIndex:NaN},fields:{},custom:{}}}}},2024:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},2450:(e,t)=>{function n(e){return null==e}function r(e){return null!=e}Object.defineProperty(t,"__esModule",{value:!0}),t.flatMapOptional=t.mapOptional=t.unsafeUnwrapOptional=t.unwrapOptional=t.isSome=t.isNothing=t.unsafeUninitialized=void 0,t.unsafeUninitialized=function(){},t.isNothing=n,t.isSome=r,t.unwrapOptional=function(e){if(n(e))throw new ReferenceError;return e},t.unsafeUnwrapOptional=function(e){return e},t.mapOptional=function(e,t){return r(e)?t(e):e},t.flatMapOptional=function(e,t){return r(e)?t(e):e}},2879:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.shallowCloneOf=void 0,t.shallowCloneOf=function(e){const t=Object.create(Object.getPrototypeOf(e));return Object.assign(t,e)}},900:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.makeMetatype=void 0,t.makeMetatype=function(e){return{name:e}}},7322:function(e){var t,n,r,o,i,a,c,s,u,l,f,d,p,v,h,m,b,y,g,w,_,j,O;e.exports=(c="millisecond",s="second",u="minute",l="hour",f="day",d="week",p="month",v="quarter",h="year",m="date",b=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[^0-9]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?.?(\d+)?$/,y=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,g={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},w=function(e,t,n){var r=String(e);return!r||r.length>=t?e:""+Array(t+1-r.length).join(n)+e},_={s:w,z:function(e){var t=-e.utcOffset(),n=Math.abs(t),r=Math.floor(n/60),o=n%60;return(t<=0?"+":"-")+w(r,2,"0")+":"+w(o,2,"0")},m:function e(t,n){if(t.date()<n.date())return-e(n,t);var r=12*(n.year()-t.year())+(n.month()-t.month()),o=t.clone().add(r,p),i=n-o<0,a=t.clone().add(r+(i?-1:1),p);return+(-(r+(n-o)/(i?o-a:a-o))||0)},a:function(e){return e<0?Math.ceil(e)||0:Math.floor(e)},p:function(e){return{M:p,y:h,w:d,d:f,D:m,h:l,m:u,s,ms:c,Q:v}[e]||String(e||"").toLowerCase().replace(/s$/,"")},u:function(e){return void 0===e}},(O={})[j="en"]=g,t=function(e){return e instanceof i},n=function(e,t,n){var r,o;return e?("string"==typeof e?(O[e]&&(r=e),t&&(O[e]=t,r=e)):(o=e.name,O[o]=e,r=o),!n&&r&&(j=r),r||!n&&j):j},r=function(e,n){if(t(e))return e.clone();var r="object"==typeof n?n:{};return r.date=e,r.args=arguments,new i(r)},(o=_).l=n,o.i=t,o.w=function(e,t){return r(e,{locale:t.$L,utc:t.$u,x:t.$x,$offset:t.$offset})},i=function(){function e(e){this.$L=n(e.locale,null,!0),this.parse(e)}var t=e.prototype;return t.parse=function(e){this.$d=function(e){var t,n,r,i=e.date,a=e.utc;return null===i?new Date(NaN):o.u(i)?new Date:i instanceof Date?new Date(i):"string"==typeof i&&!/Z$/i.test(i)&&(t=i.match(b))?(n=t[2]-1||0,r=(t[7]||"0").substring(0,3),a?new Date(Date.UTC(t[1],n,t[3]||1,t[4]||0,t[5]||0,t[6]||0,r)):new Date(t[1],n,t[3]||1,t[4]||0,t[5]||0,t[6]||0,r)):new Date(i)}(e),this.$x=e.x||{},this.init()},t.init=function(){var e=this.$d;this.$y=e.getFullYear(),this.$M=e.getMonth(),this.$D=e.getDate(),this.$W=e.getDay(),this.$H=e.getHours(),this.$m=e.getMinutes(),this.$s=e.getSeconds(),this.$ms=e.getMilliseconds()},t.$utils=function(){return o},t.isValid=function(){return!("Invalid Date"===this.$d.toString())},t.isSame=function(e,t){var n=r(e);return this.startOf(t)<=n&&n<=this.endOf(t)},t.isAfter=function(e,t){return r(e)<this.startOf(t)},t.isBefore=function(e,t){return this.endOf(t)<r(e)},t.$g=function(e,t,n){return o.u(e)?this[t]:this.set(n,e)},t.unix=function(){return Math.floor(this.valueOf()/1e3)},t.valueOf=function(){return this.$d.getTime()},t.startOf=function(e,t){var n,r,i=this,a=!!o.u(t)||t,c=o.p(e),v=function(e,t){var n=o.w(i.$u?Date.UTC(i.$y,t,e):new Date(i.$y,t,e),i);return a?n:n.endOf(f)},b=function(e,t){return o.w(i.toDate()[e].apply(i.toDate("s"),(a?[0,0,0,0]:[23,59,59,999]).slice(t)),i)},y=this.$W,g=this.$M,w=this.$D,_="set"+(this.$u?"UTC":"");switch(c){case h:return a?v(1,0):v(31,11);case p:return a?v(1,g):v(0,g+1);case d:return r=(y<(n=this.$locale().weekStart||0)?y+7:y)-n,v(a?w-r:w+(6-r),g);case f:case m:return b(_+"Hours",0);case l:return b(_+"Minutes",1);case u:return b(_+"Seconds",2);case s:return b(_+"Milliseconds",3);default:return this.clone()}},t.endOf=function(e){return this.startOf(e,!1)},t.$set=function(e,t){var n,r,i=o.p(e),a="set"+(this.$u?"UTC":""),d=(n={},n[f]=a+"Date",n[m]=a+"Date",n[p]=a+"Month",n[h]=a+"FullYear",n[l]=a+"Hours",n[u]=a+"Minutes",n[s]=a+"Seconds",n[c]=a+"Milliseconds",n)[i],v=i===f?this.$D+(t-this.$W):t;return i===p||i===h?((r=this.clone().set(m,1)).$d[d](v),r.init(),this.$d=r.set(m,Math.min(this.$D,r.daysInMonth())).$d):d&&this.$d[d](v),this.init(),this},t.set=function(e,t){return this.clone().$set(e,t)},t.get=function(e){return this[o.p(e)]()},t.add=function(e,t){var n,i,a,c,v,m=this;return e=Number(e),a=function(t){var n=r(m);return o.w(n.date(n.date()+Math.round(t*e)),m)},(i=o.p(t))===p?this.set(p,this.$M+e):i===h?this.set(h,this.$y+e):i===f?a(1):i===d?a(7):(c=(n={},n[u]=6e4,n[l]=36e5,n[s]=1e3,n)[i]||1,v=this.$d.getTime()+e*c,o.w(v,this))},t.subtract=function(e,t){return this.add(-1*e,t)},t.format=function(e){var t,n,r,i,a,c,s,u,l,f,d,p,v=this;return this.isValid()?(t=e||"YYYY-MM-DDTHH:mm:ssZ",n=o.z(this),r=this.$locale(),i=this.$H,a=this.$m,c=this.$M,s=r.weekdays,u=r.months,l=function(e,n,r,o){return e&&(e[n]||e(v,t))||r[n].substr(0,o)},f=function(e){return o.s(i%12||12,e,"0")},d=r.meridiem||function(e,t,n){var r=e<12?"AM":"PM";return n?r.toLowerCase():r},p={YY:String(this.$y).slice(-2),YYYY:this.$y,M:c+1,MM:o.s(c+1,2,"0"),MMM:l(r.monthsShort,c,u,3),MMMM:l(u,c),D:this.$D,DD:o.s(this.$D,2,"0"),d:String(this.$W),dd:l(r.weekdaysMin,this.$W,s,2),ddd:l(r.weekdaysShort,this.$W,s,3),dddd:s[this.$W],H:String(i),HH:o.s(i,2,"0"),h:f(1),hh:f(2),a:d(i,a,!0),A:d(i,a,!1),m:String(a),mm:o.s(a,2,"0"),s:String(this.$s),ss:o.s(this.$s,2,"0"),SSS:o.s(this.$ms,3,"0"),Z:n},t.replace(y,(function(e,t){return t||p[e]||n.replace(":","")}))):"Invalid Date"},t.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},t.diff=function(e,t,n){var i,a=o.p(t),c=r(e),m=6e4*(c.utcOffset()-this.utcOffset()),b=this-c,y=o.m(this,c);return y=(i={},i[h]=y/12,i[p]=y,i[v]=y/3,i[d]=(b-m)/6048e5,i[f]=(b-m)/864e5,i[l]=b/36e5,i[u]=b/6e4,i[s]=b/1e3,i)[a]||b,n?y:o.a(y)},t.daysInMonth=function(){return this.endOf(p).$D},t.$locale=function(){return O[this.$L]},t.locale=function(e,t){if(!e)return this.$L;var r=this.clone(),o=n(e,t,!0);return o&&(r.$L=o),r},t.clone=function(){return o.w(this.$d,this)},t.toDate=function(){return new Date(this.valueOf())},t.toJSON=function(){return this.isValid()?this.toISOString():null},t.toISOString=function(){return this.$d.toISOString()},t.toString=function(){return this.$d.toUTCString()},e}(),a=i.prototype,r.prototype=a,[["$ms",c],["$s",s],["$m",u],["$H",l],["$W",f],["$M",p],["$y",h],["$D",m]].forEach((function(e){a[e[1]]=function(t){return this.$g(t,e[0],e[1])}})),r.extend=function(e,t){return e.$i||(e(t,i,r),e.$i=!0),r},r.locale=n,r.isDayjs=t,r.unix=function(e){return r(1e3*e)},r.en=O[j],r.Ls=O,r.p={},r)},8063:function(e){var t,n,r,o,i,a,c,s,u,l,f,d,p;e.exports=(n={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"},r=function(e,t){return e.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,(function(e,r,o){var i=o&&o.toUpperCase();return r||t[o]||n[o]||t[i].replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,(function(e,t,n){return t||n.slice(1)}))}))},o=/(\[[^[]*\])|([-:/.()\s]+)|(A|a|YYYY|YY?|MM?M?M?|Do|DD?|hh?|HH?|mm?|ss?|S{1,3}|z|ZZ?)/g,s=function(e){return function(t){this[e]=+t}},u=[/[+-]\d\d:?(\d\d)?/,function(e){(this.zone||(this.zone={})).offset=function(e){if(!e)return 0;var t=e.match(/([+-]|\d\d)/g),n=60*t[1]+(+t[2]||0);return 0===n?0:"+"===t[0]?-n:n}(e)}],l=function(e){var n=t[e];return n&&(n.indexOf?n:n.s.concat(n.f))},f=function(e,n){var r,o,i=t.meridiem;if(i){for(o=1;o<=24;o+=1)if(e.indexOf(i(o,0,n))>-1){r=o>12;break}}else r=e===(n?"pm":"PM");return r},d={A:[c=/\d*[^\s\d-:/()]+/,function(e){this.afternoon=f(e,!1)}],a:[c,function(e){this.afternoon=f(e,!0)}],S:[/\d/,function(e){this.milliseconds=100*+e}],SS:[i=/\d\d/,function(e){this.milliseconds=10*+e}],SSS:[/\d{3}/,function(e){this.milliseconds=+e}],s:[a=/\d\d?/,s("seconds")],ss:[a,s("seconds")],m:[a,s("minutes")],mm:[a,s("minutes")],H:[a,s("hours")],h:[a,s("hours")],HH:[a,s("hours")],hh:[a,s("hours")],D:[a,s("day")],DD:[i,s("day")],Do:[c,function(e){var n,r=t.ordinal,o=e.match(/\d+/);if(this.day=o[0],r)for(n=1;n<=31;n+=1)r(n).replace(/\[|\]/g,"")===e&&(this.day=n)}],M:[a,s("month")],MM:[i,s("month")],MMM:[c,function(e){var t=l("months"),n=(l("monthsShort")||t.map((function(e){return e.substr(0,3)}))).indexOf(e)+1;if(n<1)throw new Error;this.month=n%12||n}],MMMM:[c,function(e){var t=l("months").indexOf(e)+1;if(t<1)throw new Error;this.month=t%12||t}],Y:[/[+-]?\d+/,s("year")],YY:[i,function(e){e=+e,this.year=e+(e>68?1900:2e3)}],YYYY:[/\d{4}/,s("year")],Z:u,ZZ:u},p=function(e,n,i){var a,c,s,u,l,f,p,v,h,m,b,y,g,w,_,j,O;try{return a=function(e){var n,i,a,c,s,u,l;for(n=(e=r(e,t&&t.formats)).match(o),i=n.length,a=0;a<i;a+=1)c=n[a],u=(s=d[c])&&s[0],l=s&&s[1],n[a]=l?{regex:u,parser:l}:c.replace(/^\[|\]$/g,"");return function(e){var t,r,o,a,c,s,u,l;for(t={},r=0,o=0;r<i;r+=1)"string"==typeof(a=n[r])?o+=a.length:(c=a.regex,s=a.parser,u=e.substr(o),l=c.exec(u)[0],s.call(t,l),e=e.replace(l,""));return function(e){var t,n=e.afternoon;void 0!==n&&(t=e.hours,n?t<12&&(e.hours+=12):12===t&&(e.hours=0),delete e.afternoon)}(t),t}}(n)(e),c=a.year,s=a.month,u=a.day,l=a.hours,f=a.minutes,p=a.seconds,v=a.milliseconds,h=a.zone,m=new Date,b=u||(c||s?1:m.getDate()),y=c||m.getFullYear(),g=0,c&&!s||(g=s>0?s-1:m.getMonth()),w=l||0,_=f||0,j=p||0,O=v||0,h?new Date(Date.UTC(y,g,b,w,_,j,O+60*h.offset*1e3)):i?new Date(Date.UTC(y,g,b,w,_,j,O)):new Date(y,g,b,w,_,j,O)}catch(e){return new Date("")}},function(e,n,r){r.p.customParseFormat=!0;var o=n.prototype,i=o.parse;o.parse=function(e){var n,o,a,c,s,u,l,f,d=e.date,v=e.utc,h=e.args;if(this.$u=v,"string"==typeof(n=h[1]))o=!0===h[2],a=!0===h[3],c=o||a,s=h[2],a&&(s=h[2]),o||(t=s?r.Ls[s]:this.$locale()),this.$d=p(d,n,v),this.init(),s&&!0!==s&&(this.$L=this.locale(s).$L),c&&d!==this.format(n)&&(this.$d=new Date("")),t=void 0;else if(n instanceof Array)for(u=n.length,l=1;l<=u;l+=1){if(h[1]=n[l-1],(f=r.apply(this,h)).isValid()){this.$d=f.$d,this.$L=f.$L,this.init();break}l===u&&(this.$d=new Date(""))}else i.call(this,e)}})}},n={};e.n=t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},e.d=(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},e.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{function t(e){return JSON.parse(JSON.stringify(e))}function n(e,t){if((0,je.isNothing)(e))throw new Error(t)}function r(e){switch(typeof e){case"string":case"number":case"boolean":return e;case"object":return Array.isArray(e)?{...e}:e;default:return}}function o(e){return(0,je.isNothing)(e)||Array.isArray(e)?e:[e]}function i(e,t=400){const n=JSON.stringify(e);return(0,je.isSome)(n)?n.substring(0,t):n}function a(e){return JSON.stringify(e)}function c(e,t){for(const[n,r]of Object.entries(t)){const t=e[n];if((0,je.isNothing)(t))return!1;if(t===Object(t))return!1;if(!RegExp(r).test(`${t}`))return!1}return!0}function s(e){const t=new Map;return{getDynamicReference:r=>{if(e.objectGraph.logger.debug(`DynamicReferences.getDynamicReference.process: key: "${r}"`),t.has(r))return e.objectGraph.logger.debug(`DynamicReferences.getDynamicReference.process -> done (cached): key: "${r}"`),t.get(r);const o=e.objectReader.clone().select(r),i=function(e){const t=e.objectReader.asString("kind");switch(t){case"computeNumber":return u(e);case"joinString":return function(e){const t=e.objectReader.asArrayType("values");n(t,"Missing 'values' property for StringJoinAction");const r=e.objectReader.asString("separator")||"";return{perform:async n=>{if(e.objectGraph.logger.info("StringJoinAction.perform"),0===t.length)return e.objectGraph.logger.info("The 'values' is an empty array."),"";const o=await Promise.all(t.map((t=>v(t,"string",n,e))));e.objectGraph.logger.debug(`StringJoinAction.perform: values = ${o.join(",")}`);const i=o.reduce(((e,t)=>(null==e?void 0:e.toString())+r+(null==t?void 0:t.toString())));return e.objectGraph.logger.debug(`StringJoinAction.perform -> done "${i}"`),i}}}(e);default:throw new Error(`Unknown dynamic reference kind: '${t}'`)}}({...e,objectReader:o});return t.set(r,i),e.objectGraph.logger.debug(`DynamicReferences.getDynamicReference.process -> done: key: "${r}"`),i}}}function u(e){return e.objectReader.assertHasKey("operation"),e.objectReader.assertHasKey("operands"),{perform:async t=>{e.objectGraph.logger.debug("ComputedNumberAction.perform");const r=await p("operation",t,{...e,objectReader:e.objectReader.clone()});n(r,"Missing 'operation' property for ComputedNumberAction");const o=e.objectReader.applyTo((n=>n.select("operands").map((async n=>await g([],t,{...e,objectReader:n.clone()}))))),i=await Promise.all(o);if(0===i.length)throw new Error("ComputedNumberAction 'operands' array is empty");switch(r){case de.addition:return e.objectGraph.logger.debug(`ComputedNumberAction.perform: ${i.join("+")}`),i.reduce(((e,t)=>e+t));case de.subtraction:return e.objectGraph.logger.debug(`ComputedNumberAction.perform: ${i.join("-")}`),i.reduce(((e,t)=>e-t));case de.multiplication:return e.objectGraph.logger.debug(`ComputedNumberAction.perform: ${i.join("*")}`),i.reduce(((e,t)=>e*t));case de.division:return e.objectGraph.logger.debug(`ComputedNumberAction.perform: ${i.join("/")}`),i.reduce(((e,t)=>{if(0===t)throw new Error("Attempt to divide by zero in ComputedNumberAction");return e/t}));default:throw new Error(`Unknown operation for ComputedNumberAction: ${r}`)}}}}function l(e,t,n,r){const o=n.objectReader.asString(e);return(0,je.isNothing)(o)||!h(o)?Promise.resolve(n.objectReader.asTypedValue(e,r)):v(o,r,t,n)}function f(e,t,n){return l(e,t,n,"number")}function d(e,t,n){return l(e,t,n,"boolean")}function p(e,t,n){return l(e,t,n,"string")}async function v(e,t,n,r){const[o,...i]=e.split(".");let a=null;switch(o){case"$system":a=function(e,t){let n;if((0,fe.keyPathsEqual)(e,"timestamp"))n=Date.now();else{if(!(0,fe.keyPathsEqual)(e,"timezoneOffset"))throw new Error(`Unknown system property reference: ${String(e)}`);n=(new Date).getTimezoneOffset()}return w(n,t)}(i,t);break;case"$config":a=y(i,r.pipelineConfigReader,t);break;case"$groupConfig":a=y(i,r.groupConfigReader,t);break;case"$queries":a=async function(e,t,n,r){if((0,je.isNothing)(n.queries))return null;let o=e,i=[];Array.isArray(e)&&e.length>0&&(o=e[0],i=e.slice(1));const a=n.queries.getQuery(o.toString());let c=await a.perform(t);return i.length>0&&c instanceof Object&&(c=new qe(c).asTypedValue(i,r)),w(c,r)}(i,n,r,t);break;case"$dynamicReferences":a=async function(e,t,n,r){if((0,je.isNothing)(n.dynamicReferences))return null;let o=e.toString();Array.isArray(e)&&e.length>0&&(o=e[0]);const i=n.dynamicReferences.getDynamicReference(o);return w(await i.perform(t),r)}(i,n,r,t);break;case"$memoryCache":a=async function(e,t,n,r){if((0,je.isNothing)(n.memoryCache))return null;let o=e,i=[];Array.isArray(e)&&e.length>0&&(o=e[0],i=e.slice(1));const a=n.memoryCache.getValue(o.toString());let c=await a.load(t);return i.length>0&&c instanceof Object&&(c=new qe(c).asTypedValue(i,r)),w(c,r)}(i,n,r,t);break;case"$event":a=function(e,t,n){return new qe(t).asTypedValue(e,n)}(i,n,t);break;default:a=e}return Promise.resolve(a)}function h(e){return(0,je.isSome)(e)&&e.startsWith("$")}async function m(e,t,n,r){let o=e;return"string"==typeof e&&h(e)&&(o=await v(e.toString(),r,t,n)),new qe({value:o}).asTypedValue("value",r)}async function b(e,t,n){return m(e,t,n,"string")}function y(e,t,n){return(0,je.isNothing)(t)?null:t.asTypedValue(e,n)}async function g(e,t,n){const r=n.objectReader.asTypedValue(e,"object");if((0,je.isNothing)(r)||"object"!=typeof r)return f(e,t,n);const o=n.objectReader.clone();return o.select(e),await u({...n,objectReader:o}).perform(t)}function w(e,t){if((0,je.isNothing)(e))return e;switch(t){case"string":return(0,le.valueAsString)(e);case"number":return(0,le.valueAsNumber)(e);case"boolean":return(0,le.valueAsBoolean)(e);case"object":return r(e);case"array":return o(e);case"any":return e;default:throw new Error(`Unknown value type: ${t}`)}}function _(e){const t=e.objectReader.asString("operation");switch(n(t,"Missing operation value for Phobos action"),t){case"map":return function(e){const t=C(e);return{process:async r=>{if(await E(r,t))return r;const o=await p("name",r,e);return n(o,"Phobos map action is missing value for key: 'name'"),(0,pe.map)(r,o)}}}(e);case"reduce":return function(e){const t=C(e);return{process:async r=>{if(await E(r,t))return r;const o=await p("name",r,e);n(o,"Phobos reduce action is missing value for key: 'name'");const i=await l("events",r,e,"array");if(n(i,"Phobos reduce action is missing value for key: 'events'"),!Array.isArray(i))throw new Error("The 'events' property for Phobos reduce action is not an array");return 0===i.length?r:(0,pe.reduce)(i,o)}}}(e);default:throw new Error(`Unknown Phobos action operation: ${t}`)}}function j(e){const t=e.objectReader.asString("kind");switch(t){case"identity":return function(e){return{test:async t=>{const n=await d("value",t,e);return(0,je.isSome)(n)&&n}}}(e);case"isSome":return O(e,!1);case"isNothing":return O(e,!0);case"not":return function(e){const t=$("value",e);return{test:async e=>!await t.test(e)}}(e);case"and":return k(e,(async(e,t)=>{for(const n of e)if(!await n.test(t))return!1;return!0}));case"or":return k(e,(async(e,t)=>{for(const n of e)if(await n.test(t))return!0;return!1}));case"xor":return k(e,(async(e,t)=>{const[n,...r]=e;let o=+await n.test(t);for(const e of r)o^=+await e.test(t);return!!o}));case"equal":return M(e,((e,t,n)=>e===t+n));case"notEqual":return M(e,((e,t,n)=>e!==t+n));case"lessThan":return M(e,((e,t,n)=>e<t+n));case"lessThanOrEqual":return M(e,((e,t,n)=>e<=t+n));case"greaterThan":return M(e,((e,t,n)=>e>t+n));case"greaterThanOrEqual":return M(e,((e,t,n)=>e>=t+n));case"match":return A(e,!1);case"notMatch":return A(e,!0);case"empty":return S(e,!1);case"notEmpty":return S(e,!0);case"includes":return T(e,!1);case"notIncludes":return T(e,!0);case"phobos":return function(e){return{test:async t=>{const r=await p("name",t,e);n(r,"Phobos predicate is missing value for key: 'name'");const o=_({...e,objectReader:new qe({kind:"phobos",operation:"map",name:r})});return 1===(await o.process(t))[r]}}}(e);case"isAppStoreAppAutoUpdate":return{test:async e=>{const t=e.responseDictionary.metrics;n(t,"IsAppStoreAppAutoUpdate predicate is missing 'responseDictionary.metrics' in the 'purchase' event");const r=e.buyParameters;return n(r,"IsAppStoreAppAutoUpdate predicate is missing 'buyParameters' in the 'purchase' event"),!(!t.sapTypes&&!t.extractedCommerceEvent_latestLineItem_sapType)&&(t.sapTypes||[t.extractedCommerceEvent_latestLineItem_sapType]).some((e=>e.startsWith("7")||e.startsWith("8")))&&null==t.mtPageContext&&null==r.mtPageContext}};default:throw new Error(`Unknown predicate kind: ${t}`)}}function O(e,t){return{test:async n=>{const r=await d("value",n,e);return t!==(0,je.isSome)(r)}}}function k(e,t){const n=e.objectReader.applyTo((t=>t.select("conditions").map((t=>j({...e,objectReader:t.clone()})))));return{test:async e=>await t(n,e)}}function M(e,t){return{test:async r=>{const o=await f("lhsValue",r,e),i=await f("rhsValue",r,e),a=e.objectReader.has("delta")?await f("delta",r,e):0;return n(o,"Number comparison predicate is missing value for key: 'lhsValue'"),n(i,"Number comparison predicate is missing value for key: 'rhsValue'"),n(a,"Number comparison predicate is missing value for key: 'delta'"),t(o,i,a)}}}function A(e,t){return{test:async n=>{const r=e.objectReader.asBoolean("ignoreCase")||!1,o=e.objectReader.asBoolean("isRegex")||!1,i=await p("lhsValue",n,e),a=await p("rhsValue",n,e);if((0,je.isNothing)(i)||(0,je.isNothing)(a))return!1;let c;if(o){const e=new RegExp(a,r?"i":"");c=null!==i.match(e)}else c=r?i.toUpperCase()===a.toUpperCase():i===a;return t!==c}}}function S(e,t){return e.objectReader.assertHasKey("value"),{test:async r=>{const o=await l("value",r,e,"array");if(n(o,"Missing 'value' property for collection empty predicate"),!Array.isArray(o))throw new Error(`The value passed to collection empty predicate is not an array: ${o}`);const i=0===o.length;return t!==i}}}function T(e,t){return e.objectReader.assertHasKey("list"),e.objectReader.assertHasKey("value"),e.objectReader.assertHasKey("valueType"),{test:async r=>{const o=e.objectReader.asValueType("valueType");n(o,"Array includes predicate is missing value for key: 'valueType'"),n(e.objectReader.asString("value"),"Array includes predicate is missing value for key: 'value'");const i=await l("value",r,e,o);(0,je.isNothing)(i)&&e.objectGraph.logger.info("Array includes predicate cannot resolve the value");const a=await l("list",r,e,"array");if(n(a,"Array includes predicate is missing value for key: 'list'"),!Array.isArray(a))throw new Error("The list passed to array includes empty predicate is not an array");const c=a.includes(i);return t!==c}}}async function E(e,t){return!!(0,je.isSome)(t)&&!await t.test(e)}function $(e,t){return t.objectReader.applyTo((n=>{const r=n.clone().select(e);return j({...t,objectReader:r})}))}function C(e,t="predicate"){return e.objectReader.has(t)?$(t,e):null}function D(e,t){!(0,je.isNothing)(e)&&N(e)&&Object.entries(e).forEach((([n,r])=>{(0,je.isSome)(r)&&N(r)?D(r,t):t({object:e,key:n,value:r})}))}function N(e){return Array.isArray(e)||Object.getPrototypeOf(e)===Object.prototype}async function R(e){const t=[],{eventFields:n,onFieldResolved:r}=e;D(n,(({object:e,key:n,value:o})=>{o instanceof Promise&&((0,je.isSome)(r)&&(e[n]=o=o.then((t=>r(n,t,e)))),t.push(o))})),await Promise.all(t)}function P(e=me.database,t){switch(e){case me.memoryCache:{let e=null;return{fetch:async n=>{const r=t.memoryCache.getValue(n);return e=await r.load({})},set:async(n,r)=>{if(r===e)return;const o=t.memoryCache.getValue(n);await o.set(r,{})}}}case me.database:return{fetch:async e=>t.objectGraph.database.fetch(e),set:async(e,n)=>{t.objectGraph.database.set(e,n)}};default:throw new Error(`Linter Rule Storage: unsupported storage type: ${e}.`)}}function x(e,t,n){null!=e&&null!=t&&"function"==typeof n&&F(e,t.split("."),null,[],null,n)}function F(e,t,n,r,o,i){if("function"==typeof e)return;if(null!==n&&r.push(n),0===t.length)return void i({object:o,key:n,keyPath:r.join("."),value:e});if(null==e)return;let a=t.shift();if(a.endsWith("[]")){a=a.slice(0,-2),r.push(a);const n=e[a];n instanceof Array&&n.forEach(((e,o)=>{F(e,t.slice(),String(o),r,n,i),r.pop()}))}else F(e[a],t,a,r,e,i);r.length>0&&r.pop()}function I(e){const{random:t,idVersion:n}=e;return{generate(e){const r=t.nextUUID(),o=function(e,t){const n=[e];return(0,ie.isSome)(t)&&n.push(t),n.map((e=>e.toString(16))).join("-")}(null!=e?e:n,Date.now())+"-"+r,i=o.split("-").map((e=>function(e,t){const n=t.length,r=[];let o,i,a="";for(;e>0;)o=e%n,i=t.charAt(o),r.push(i),e=(e-o)/n;return a=r.reverse().join(""),""===a&&(a="0"),a}(Number.parseInt(e,16),"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxy"))).join("z");return null!=i?i:"0"}}}function V(){return{getConfigProps:()=>[{propName:"namespace",propType:"string"},{propName:"key",propType:"string"},{propName:"crossDeviceSync",propType:"boolean"},{propName:"excludeDebuggingFields",propType:"boolean"}],async applyWithFieldValue({resolvedRuleConfig:e,eventFields:t,context:n}){const{accountStore:r}=n,{namespace:o,key:i,crossDeviceSync:a,excludeDebuggingFields:c}=e,s=await n.metrics.loadIdentifierFields(r.activeiTunes,o,i,a),u=s[i];return(0,je.isSome)(u)&&!0!==c&&(function(e,t,n){for(const[r,o]of Object.entries(t))r!==n.key&&(e[r]=o)}(t,s,e),t.xpAccountsMatch=(0,je.isSome)(r.activeiCloud)&&(0,je.isSome)(r.activeiTunes)&&r.activeiCloud.dsid===r.activeiTunes.dsid),u}}}function Y(e,t,n){const r=(e||"").split("?"),o=n||r[0],i=function(e){return(e||"").split("#")[0]}(r[1]).split("&"),a=i.filter((e=>{const[n,r]=e.split("=");return Array.isArray(t)?t.includes(n):"object"==typeof t&&"object"==typeof t[n]&&Array.isArray(t[n].allowedValues)&&t[n].allowedValues.includes(r)})).join("&");return a.length>0?o+"?"+a:o}function L(e,t){async function n(t,n,r,o,i,a){return await e.applyWithFieldValue({value:o,field:r,resolvedRuleConfig:i,eventFields:n,context:a})}const{fields:r,source:o}=t;return{apply(i,a){if((0,je.isSome)(r)){const r=a,c=function(e,t,n){let r=null;switch(e){case ve.ORIGINAL_EVENT:r=n.originalEventFields;break;case ve.PROCESSING_EVENT:default:r=t}return r}(o,i,r),s=r.resolveRuleConfig(t,c,e.getConfigProps());let u=Promise.resolve();t.fields.forEach((e=>{x(c,e,(({value:t,keyPath:o})=>{let a=null;a=t instanceof Promise?Promise.all([u,s,t]).then((([t,o,i])=>n(0,c,e,i,o,r))):Promise.all([u,s]).then((([o,i])=>n(0,c,e,t,i,r))),x(i,e,(({object:e,key:t,keyPath:n})=>{n===o&&(e[t]=u=u.then((()=>a)).then((n=>(e[t]=n,n))))}))}))}))}}}}async function U(e,t){const n=[];return t.forEach((t=>{x(e,t,(({object:e,key:t})=>{const r=Promise.resolve(e[t]).then((n=>{e[t]=n}));n.push(r)}))})),await Promise.all(n),e}function q(e){const t=e.objectReader.asString("kind");switch(t){case"dropEvent":return function(e){const t=C(e);return{process:async n=>(e.objectGraph.logger.info("DropEventAction.process"),await E(n,t)?(e.objectGraph.logger.info("DropEventAction.process -> predicate test failed"),n):(e.objectGraph.logger.info("DropEventAction.process -> done"),null))}}(e);case"addField":return z(e,0);case"updateField":return z(e,1);case"removeField":return z(e,2);case"convertDate":return z(e,3);case"round":return z(e,4);case"compound":return G(e);case"conditional":return function(e){const t=C(e,"ifPredicate");n(t,"Conditional action is missing value for key: 'ifPredicate'"),e.objectReader.assertHasKey("thenAction");const r=q({...e,objectReader:e.objectReader.clone().select("thenAction")});n(r,"Conditional action is missing value for key: 'thenAction'");const o=C(e,"elsePredicate");let i=null;if(e.objectReader.has("elseAction")){const t=e.objectReader.clone().select("elseAction");i=q({...e,objectReader:t})}return{process:async a=>(e.objectGraph.logger.info("ConditionalAction.process"),await t.test(a)?(e.objectGraph.logger.info("ConditionalAction.process -> if"),r.process(a)):(0,je.isSome)(o)&&await o.test(a)?(e.objectGraph.logger.info("ConditionalAction.process -> else-if"),n(i,"Conditional action is missing value for key: 'elseAction'"),i.process(a)):(0,je.isNothing)(o)&&(0,je.isSome)(i)?(e.objectGraph.logger.info("ConditionalAction.process -> else"),i.process(a)):(e.objectGraph.logger.info("ConditionalAction.process -> done"),a))}}(e);case"forEach":return function(e){e.objectReader.assertHasKey("events"),e.objectReader.assertHasKey("actions");const t=e.objectReader.asBoolean("processIncomingEvent");if(0===e.objectReader.asArrayType("actions").length)throw new Error("ForEach action's 'actions' config is empty");const n=G(e);return{process:async r=>{e.objectGraph.logger.info("ForEachAction.process");let o=await l("events",{},e,"array");if((0,je.isNothing)(o))return e.objectGraph.logger.info("ForEachAction.process -> 'events' is referencing a null value, will skip the looping"),r;e.objectGraph.logger.info(`ForEachAction.process -> 'processIncomingEvent' = ${t}`),t&&(o=[...o,r]),e.objectGraph.logger.info(`ForEachAction.process -> ${o.length} events`);for(let t=0;t<o.length;t+=1){e.objectGraph.logger.info(`ForEachAction.process -> processing index = ${t}`);const r=o[t];await n.process(r)}return e.objectGraph.logger.info("ForEachAction.process -> done"),r}}}(e);case"addCommonFields":return H(e);case"writeToDatabase":return function(e){const t=C(e);return{process:async r=>{if(e.objectGraph.logger.info("WriteToDatabaseAction.process"),await E(r,t))return e.objectGraph.logger.info("WriteToDatabaseAction.process -> predicate test failed"),r;const o=await p("key",r,e);n(o,"Write to database action is missing value for key: 'key'");const a=e.objectReader.asValueType("valueType");n(a,"Write to database action is missing value for key: 'valueType'");const c=await l("value",r,e,a);return e.objectGraph.database.set(o,c),e.objectGraph.logger.info(`WriteToDatabaseAction.process (key=${o}, value=${i(c)}) -> done`),r}}}(e);case"writeToMemoryCache":return function(e){const t=C(e),r=e.objectReader.asString("value");return{process:async o=>{if(e.objectGraph.logger.info("WriteToMemoryCacheAction.process"),await E(o,t))return e.objectGraph.logger.info("WriteToMemoryCacheAction.process -> predicate test failed"),o;const i=await p("key",o,e);n(i,"Write to memory cache action is missing value for key: 'key'");const a=e.memoryCache.getValue(i);return await a.set(r,o),e.objectGraph.logger.info(`WriteToMemoryCacheAction.process (key=${i}, value=${r}) -> done`),o}}}(e);case"lintEvent":return function(e){const t=C(e),n=e.objectReader.applyTo((t=>t.select("rules").map((t=>function(e,t){const{kind:n}=e;let r;switch(n){case"denyFields":r=function(e){return{apply(t,n){const{fields:r}=e;R({eventFields:t}).finally((()=>{r.forEach((e=>{delete t[e]}))}))}}}(e);break;case"allowFields":r=function(e){return{apply(t,n){if((0,je.isSome)(e.fields)&&e.fields.length>0){const{fields:n}=e;R({eventFields:t}).finally((()=>{for(const e of Object.keys(t))n.includes(e)||delete t[e]}))}}}}(e);break;case"number":r=L({getConfigProps:()=>[{propName:"precision",propType:"number"}],async applyWithFieldValue({value:e,resolvedRuleConfig:t}){const{precision:n}=t;let r=e;return"number"==typeof r&&(0,je.isSome)(n)&&(r=n>0?(0,be.reduceSignificantDigits)(r,n):Number.NaN),r}},e);break;case"bucketing":r=L(function(){const e="start";return{getConfigProps:()=>null,applyWithFieldValue({value:t,resolvedRuleConfig:n}){let{buckets:r}=n,o=t;if((0,je.isSome)(r)&&"number"==typeof t){r=r.slice().sort(((t,n)=>t[e]-n[e]));const n=function(t,n){let r=-1;if((0,je.isNothing)(n)||0===t.length||(0,je.isSome)(t[0])&&n<t[0][e])return-1;if(t[t.length-1][e]<n)r=t.length-1;else for(let o=0;o<t.length;o+=1){const i=t[o][e];if(i===n){r=o;break}if(i>n){r=o-1;break}}return r}(r,t),i=r[n];(0,je.isSome)(i)&&(o=i.value)}return Promise.resolve(o)}}}(),e);break;case"time":r=L(function(e){function t(e,t){var n;const r=(0,je.isSome)(t.namespace)?"_"+t.namespace:"";return(null!==(n=t.storageKeyPrefix)&&void 0!==n?n:Be)+r+"_"+e}return{getConfigProps:()=>[{propName:"precision",propType:"number"},{propName:"namespace",propType:"string"},{propName:"storageKeyPrefix",propType:"string"},{propName:"storageKeyPostfix",propType:"string"},{propName:"storageType",propType:"string"}],async applyWithFieldValue({value:n,resolvedRuleConfig:r,field:o}){const i=r;let a=n;if(Number.isInteger(n)&&(0,je.isSome)(i)&&i.precision>0){let r=null;const{fields:c,storageKeyPostfix:s,precision:u}=i;r=function(e,t){let n;return n=(0,je.isSome)(e)?e:1===t.length?t[0]:t.length>1?t.join("_"):"",n}(s,c);const l=function(e){async function t(e){const t={expiration:e,serialNumber:s};return await l.set(c,t),t}async function n(e){return await l.fetch(e)}async function r(e,r){let o,i,a=await n(e);for(o=(0,je.isSome)(a)?a.expiration:Math.floor(r/u)*u;r>=o;)o=i=o+u,a=await t(i);return a}var o,i,a;const c=null!==(o=e.namespace)&&void 0!==o?o:"sequence",s=null!==(i=e.initialSerialNumber)&&void 0!==i?i:0,u=null!==(a=e.rotationPeriod)&&void 0!==a?a:Number.POSITIVE_INFINITY,l=e.storage;return{getSerialNumber:async e=>(await r(c,e)).serialNumber,getNextSerialNumber:async(e,t)=>{const n=await r(c,e);let o=n.serialNumber;return o=function(e,t){return e+t}(o,t=null!=t?t:1),n.serialNumber=o,await l.set(c,n),o},resetSerialNumber:async()=>{const e=await n(c);(0,je.isSome)(e)&&await t(e.expiration)}}}({storage:P(i.storageType,e),namespace:t(r,i),rotationPeriod:u}),f=function(e,t){return Math.floor(e/t)*t}(n,i.precision);let d;d=c.indexOf(o)>0?await l.getSerialNumber(f):await l.getNextSerialNumber(n),a=function(e,t){return e+t}(f,d)}return a}}}(t),e);break;case"calculation":r=L({getConfigProps:()=>null,async applyWithFieldValue({value:e,resolvedRuleConfig:t,eventFields:n,context:r}){const{operationFields:o,operation:i}=t,a=function(e){let t;switch(e){case de.addition:t=(e,t)=>e+t;break;case de.subtraction:t=(e,t)=>e-t;break;case de.multiplication:t=(e,t)=>e*t;break;case de.division:t=(e,t)=>0!==t?e/t:Number.NaN;break;default:t=()=>Number.NaN}return t}(i);let c=null;if(o.length>1){x(await r.resolveEventFields(n,o),o[0],(({value:e})=>{c=null==c?e:Number.isFinite(c)&&Number.isFinite(e)?a(c,e):Number.NaN}));for(let e=1;e<o.length;e+=1)x(n,o[e],(({value:e})=>{c=Number.isFinite(c)&&Number.isFinite(e)?a(c,e):Number.NaN}))}else c=e;return Number.isFinite(c)?c:e}},e);break;case"timeBasedId":r=L(function(e){function t(e,t){let n="";return(0,je.isSome)(e)?n=e:1===t.length?n=t[0]:t.length>1&&(n=t.join("_")),n}function n(e,t){const{namespace:n,storageKeyPrefix:o}=t,i=(0,je.isSome)(n)?"_"+n:"";return(null!=o?o:r)+i+"_"+e}const r="linter_timeBasedId",o=I({random:e.objectGraph.random,idVersion:4});return{getConfigProps:()=>[{propName:"namespace",propType:"string"},{propName:"storageKeyPrefix",propType:"string"},{propName:"storageKeyPostfix",propType:"string"},{propName:"lifespan",propType:"number"},{propName:"timeField",propType:"string"},{propName:"storageType",propType:"string"}],async applyWithFieldValue({eventFields:r,resolvedRuleConfig:i,context:a}){const{timeField:c,storageType:s}=i,u=P(s,e);let l;(null==c?void 0:c.includes("[]"))&&e.objectGraph.logger.info("time-based-id-rule: Unexpected array field usage. The last value of the array will be used"),await a.resolveEventFields(r,[c]),x(r,c,(({value:e})=>{l=e}));const f=(0,je.isSome)(c)?l:Date.now(),d=await async function(e,r){const{storageKeyPostfix:o,fields:i}=e,a=n(t(o,i),e);return await r.fetch(a)}(i,u);let p;return(0,je.isNothing)(d)||(0,je.isNothing)(f)||Number.isInteger(d.expirationTime)&&f>=d.expirationTime?(p=o.generate(),await async function(e,r,o,i){const{storageKeyPostfix:a,fields:c,lifespan:s}=o,u=n(t(a,c),o),l={expirationTime:(null!=r?r:Date.now())+s,id:e};await i.set(u,l)}(p,f,i,u)):p=d.id,p}}}(t),e);break;case"userId":r=L(V(),e);break;case"url":r=L(function(e){return{getConfigProps:()=>[{propName:"scope",propType:"string"},{propName:"allowedParams",propType:"object"}],async applyWithFieldValue({value:t,resolvedRuleConfig:n}){const{scope:r}=n;let o=t;return"string"==typeof t?r===he.Hostname?o=function(e){const t=e||"",n=Y(t).split("/");let r;return r=t.includes("//")?n[2]:n[0],r.substring(r.indexOf("@")+1).split(":")[0]}(t):r===he.FullWithoutParams?o=function(e){let t=e.value;if("allowedParams"in e.resolvedRuleConfig&&null!=e.resolvedRuleConfig.allowedParams){const n=e.resolvedRuleConfig.allowedParams;t=Y(e.value,n,e.urlPrefixOverride)}else e.args.objectGraph.logger.error("url-rule: allowedParams not defined");return t}({value:t,resolvedRuleConfig:n,args:e}):e.objectGraph.logger.error("url-rule: No scope defined"):e.objectGraph.logger.error("url-rule: Value is not a string"),o}}}(t),e);break;case"relativeFieldAdjustment":{const n=function(e){return{getConfigProps:()=>[{propName:"baseField",propType:"string"},{propName:"operation",propType:"string"},{propName:"adjustmentMode",propType:"string"},{propName:"operandPosition",propType:"string"}],async applyWithFieldValue({value:t,resolvedRuleConfig:n,eventFields:r}){let o=t;const{baseField:i,operation:a,adjustmentMode:c,operandPosition:s}=n,u=r[i];if("number"==typeof t&&"number"==typeof u)switch(c){case"direct":switch(a){case"addition":o="lhs"===s?u+t:t+u;break;case"subtraction":o="lhs"===s?u-t:t-u;break;case"multiplication":o="lhs"===s?u*t:t*u;break;case"division":o="lhs"===s?u/t:t/u;break;default:e.objectGraph.logger.error("relative-arithmetic-rule: Unexpected operation")}break;case"proportional":switch(a){case"addition":o="lhs"===s?u+u*(t/He):t+t*(u/He);break;case"subtraction":o="lhs"===s?u-u*(t/He):t-t*(u/He);break;case"multiplication":o="lhs"===s?u*(t/He):t*(u/He);break;case"division":o="lhs"===s?u/(t/He):t/(u/He);break;default:e.objectGraph.logger.error("relative-arithmetic-rule: Unexpected operation")}break;default:e.objectGraph.logger.error("relative-arithmetic-rule: Unexpected adjustment mode")}else e.objectGraph.logger.error("relative-arithmetic-rule: Value is not a number");return o}}}(t);r=L(n,e);break}default:throw new Error(`Unknown linter rule kind: ${n}`)}return r}(t.asObjectType(),e))))),r=async(t,n,r)=>{const o=await async function(e,t,n,r){const o=Object.create(e);if((0,je.isSome)(r))for(const{propName:e,propType:i}of r)o[e]=await m(o[e],t,n,i);return o}(t,n,e,r);return o},o={environment:{buildType:e.objectGraph.client.buildType,jsVersion:e.objectGraph.packageProperties.version},defaultTopic:"",configuration:{baseFields:t=>{const n=e.objectReader.clone().select("baseFields");return(0,je.isNothing)(n)?null:n.asObjectType(t)},compoundSeparator:t=>{const n=e.objectReader.clone().select("compoundSeparator");return(0,je.isNothing)(n)?null:n.asString(t)},deResolutionRules:e=>[]},rules:n,isLoggingEnabled:!1},i=new ue.B(o);return{process:async n=>{if((0,je.isSome)(t)&&!await t.test(n))return n;const o={originalEventFields:n,storage:e.objectGraph.database,logger:e.objectGraph.logger,random:e.objectGraph.random,metrics:e.objectGraph.metrics,accountStore:e.objectGraph.accountStore,resolveRuleConfig:r,resolveEventFields:U},a=i.lint(n,o).fields;return await R({eventFields:a}),a}}}(e);case"enqueueEvent":return B(e);case"phobos":return _(e);case"enqueueEvents":return function(e){var t;e.objectReader.assertHasKey("eventCache");const r=C(e),o=null!==(t=e.objectReader.asNumber("batchSize"))&&void 0!==t?t:500;return{process:async t=>{if(e.objectGraph.logger.info("EnqueueBatchEventAction.process"),await E(t,r))return e.objectGraph.logger.info("EnqueueBatchEventAction.process -> predicate test failed"),t;const i=await l("eventCache",{},e,"array");if(i.push(t),i.length<o)return e.objectGraph.logger.info(`EnqueueBatchEventAction.process -> done (cache size: ${i.length}, batch size: ${o})`),t;const a=await p("topic",t,e);n(a,'EnqueueBatchEventAction is missing value for key: "topic"');const c=await d("personalized",t,e),s=await l("account",t,e,"object"),u={events:i,topic:a,personalized:c};return(0,je.isSome)(s)&&(u.account=s),await W(e,u),e.objectGraph.logger.info(`EnqueueBatchEventAction.process -> done (enqueued ${i.length} events)`),i.length=0,t}}}(e);case"enqueueCachedEvents":return function(e){e.objectReader.assertHasKey("events");const t=C(e);return{process:async r=>{if(e.objectGraph.logger.info("EnqueueCachedEventsAction.process"),await E(r,t))return e.objectGraph.logger.info("EnqueueCachedEventsAction.process -> predicate test failed"),r;const o=await l("events",{},e,"array"),i=await p("topic",r,e);n(i,'EnqueueCachedEventsAction is missing value for key: "topic"');const a=await d("personalized",r,e),c=await l("account",r,e,"object"),s={events:o,topic:i,personalized:a};return(0,je.isSome)(c)&&(s.account=c),await W(e,s),e.objectGraph.logger.info(`EnqueueCachedEventsAction.process -> done (enqueued ${o.length} events)`),r}}}(e);case"flushEvents":return function(e){return{process:async t=>(e.objectGraph.logger.info("FlushEventsAction.process"),await e.objectGraph.metrics.flush(),e.objectGraph.logger.info("FlushEventsAction.process -> done"),t)}}(e);case"merge":return function(e){var t;const r=C(e),o=null===(t=e.objectReader.select("sources").asArrayType())||void 0===t?void 0:t.slice();if(n(o,"Merge action is missing value for key: 'sources'"),!o.every((e=>"object"==typeof e||"string"==typeof e)))throw new Error("Merge action sources must either be a string or an object literal");return{process:async t=>{if(await E(t,r))return e.objectGraph.logger.info("MergeEventAction.process -> predicate test failed"),t;o.reverse();const n=o.map((n=>async function(e,t,n){let r;return r="string"==typeof n?function(e,t){let n={};if("string"==typeof t)try{n=JSON.parse(t)}catch(n){e.objectGraph.logger.error(`Unable to parse input "${t}" to an object (${n})`)}else"object"==typeof t&&(n=t);return n}(e,await v(n,"object",t,e)):n,r}(e,t,n).catch((t=>(e.objectGraph.logger.error(`Unable to parse source ${n}: ${t}`),{}))))),i={},a=await Promise.all(n);return Object.assign(i,...a),i}}}(e);default:throw new Error(`Unknown event action kind: ${t}`)}}function B(e){const t=C(e);return{process:async r=>{e.objectGraph.logger.info("EnqueueEventAction.process");const o=await p("topic",r,e),i=await d("personalized",r,e),a=await l("account",r,e,"object"),c={};return(0,je.isSome)(i)&&(c.personalized=i),(0,je.isSome)(a)&&(c.account=a),n(o,"Missing topic for enqueueEvent action"),((0,je.isNothing)(t)||await t.test(r))&&e.objectGraph.metrics.enqueue(o,r,c),e.objectGraph.logger.info("EnqueueEventAction.process -> done"),r}}}function H(e){const n={appVersion:e.objectGraph.client.clientVersion,hardwareModel:e.objectGraph.host.devicePhysicalModel,hardwareFamily:e.objectGraph.host.deviceModelFamily,os:e.objectGraph.host.platform,osBuildNumber:e.objectGraph.host.osBuild,userAgent:e.objectGraph.client.userAgent,resourceRevNum:e.objectGraph.packageProperties.version,timezoneOffset:(new Date).getTimezoneOffset(),xpSendMethod:"jet-js",baseVersion:1},r=e.objectReader.asObjectType("optionalFields"),o=C(e);return{async process(i){var a;if(e.objectGraph.logger.info("AddCommonFieldsAction.process"),await E(i,o))return e.objectGraph.logger.info("AddCommonFieldsAction.process -> predicate test failed"),i;const c=e.objectGraph.accountStore,s=t(i),u={...n,eventTime:Date.now(),isSignedIn:c.isSignedIn,storeFrontHeader:null===(a=c.activeiTunes)||void 0===a?void 0:a.storefront};for(const[e,t]of Object.entries(u))s[e]=t;return(0,je.isSome)(r)&&!0===r.buildFlavor&&(s.buildFlavor="customer"),e.objectGraph.logger.info("AddCommonFieldsAction.process -> done"),s}}}function z(e,r){const o=C(e);return{process:async i=>{if(e.objectGraph.logger.info("ModifyFieldAction.process"),await E(i,o))return e.objectGraph.logger.info("ModifyFieldAction.process -> predicate test failed"),i;const a=await p("key",i,e);n(a,"Modify field action is missing value for key: 'key'");const c=t(i);switch(r){case 0:case 1:{const t=e.objectReader.asValueType("valueType");n(t,"Modify field action is missing value for key: 'valueType'"),n(e.objectReader.asString("value"),"Modify field action is missing value for key: 'value'");const r=await l("value",i,e,t);(0,je.isNothing)(r)&&e.objectGraph.logger.info("Modify field action cannot resolve the value"),c[a]=r}break;case 2:delete c[a];break;case 3:{const t=e.objectReader.asValueType("targetValueType");n(t,"ConvertDate action is missing value for key: 'targetValueType'");const r=e.objectReader.asString("value");if((0,je.isSome)(r)){const n="number"===t?"string":"number",r=await l("value",i,e,n);(0,je.isNothing)(r)?e.objectGraph.logger.debug("ConvertDate action cannot resolve inputValue"):c[a]=r}if((0,je.isNothing)(c[a]))throw new Error("ConvertDate Action Error: No value to convert");const o=e.objectReader.asString("inputFormat");let s;switch(t){case"string":"number"==typeof c[a]&&(s=String(ge()(c[a])));break;case"number":"string"==typeof c[a]&&(s=(0,je.isNothing)(o)?Number(ge()(c[a],ze)):Number(ge()(c[a],[o]))),isNaN(s)&&(s=null);break;default:throw new Error(`Cannot process targetValueType ${t} for field ${a}`)}(0,je.isNothing)(s)?e.objectGraph.logger.default(`ConvertDate Action Skipped (Invalid inputs): Cannot convert field ${a} to ${t} with inputFormat: ${null!=o?o:"default"}`):c[a]=s}break;case 4:{const t=e.objectReader.asString("value");if((0,je.isSome)(t)){const t=await f("value",i,e);(0,je.isNothing)(t)?e.objectGraph.logger.default("Round field action cannot resolve the value"):c[a]=t}if((0,je.isNothing)(c[a]))throw new Error("Round Action Failed: No value to round");let n=c[a];if("number"==typeof c[a]){const t=e.objectReader.asNumber("precision")?e.objectReader.asNumber("precision"):0,r=e.objectReader.asBoolean("truncate");n=t>0?Number(c[a].toFixed(t)):r?Math.trunc(c[a]):Math.round(c[a])}else e.objectGraph.logger.default("Round field action cannot round non-numerical value");c[a]=n}break;default:throw new Error(`Unknown field modification action type: ${r}`)}return e.objectGraph.logger.info("ModifyFieldAction.process -> done"),c}}}function G(e){const t=C(e),r=e.objectReader.applyTo((t=>t.select("actions").map((t=>q({...e,objectReader:t.clone()})))));if(n(r,"Compound action is missing value for key: 'actions'"),0===r.length)throw new Error("Compound action's 'actions' array is empty");return{process:async n=>{e.objectGraph.logger.info("CompoundAction.process");let o=n;if(await E(n,t))return e.objectGraph.logger.info("CompoundAction.process -> predicate test failed"),o;for(const e of r)o=await e.process(o);return e.objectGraph.logger.info("CompoundAction.process -> done"),o}}}async function W(e,t){const{events:n,topic:r,personalized:o,account:i}=t;if(0===n.length)return;const a={};(0,je.isSome)(o)&&(a.personalized=o),(0,je.isSome)(i)&&(a.account=i),e.objectGraph.metrics.enqueueBatch({[r]:n},a)}function J(e){const t=e.objectReader.asString("kind");switch(t){case"readFromDatabase":return function(e){return{perform:async t=>{const r=await p("key",t,e);e.objectGraph.logger.debug(`ReadFromDatabaseAction.perform(key: ${r})`),n(r,"Read from database action is missing value for key: 'key'");const o=e.objectGraph.database.fetch(r);return e.objectGraph.logger.debug(`ReadFromDatabaseAction.perform(key: ${r}) -> ${i(o)}`),o}}}(e);case"queryBacklog":return function(e){return e.objectReader.assertHasKey("predicate"),{perform:async t=>{e.objectGraph.logger.debug("QueryBacklogAction.perform");const r=await K(t,{...e,objectReader:e.objectReader.clone().select("predicate")});n(r,"Query Backlog action is missing value for key: 'predicate'");const o=await f("batchSize",t,e),c=await f("limit",t,e),s=[];if(e.objectGraph.logger.debug(`QueryBacklogAction.perform(predicate: ${a(r)}, batchSize: ${o}, limit: ${c})`),!(await e.objectGraph.backlog.lookup(r,(e=>(s.push(...e),!0)),o,c)).success)throw new Error("Failed to fetch events from Backlog");return e.objectGraph.logger.debug(`QueryBacklogAction.perform() -> result.size: ${s.length}, result.body: ${i(s)}`),s}}}(e);case"host":return function(e){let t;return function(e){e.platform="platform",e.osBuild="osBuild",e.deviceModel="deviceModel",e.clientVersion="clientVersion"}(t||(t={})),{perform:async r=>{const o=await p("key",r,e);e.objectGraph.logger.debug(`ReadHostAction.perform(key: ${o})`),n(o,"Read from host action is missing value for key: 'key'");const i=e.objectGraph.host;if(!(o in t))throw new Error(`The Key (${o}) does not exist in the Host object.`);return e.objectGraph.logger.debug(`ReadHostAction.perform(key: ${o}) -> ${i[o]}`),i[o]}}}(e);case"subscriptionStatus":return Q(e);case"accountStore":return function(e){let t;return function(e){e.iTunes="activeiTunes",e.iCloud="activeiCloud",e.isSignedIn="isSignedIn"}(t||(t={})),{perform:async r=>{const o=await p("type",r,e),a=await p("prop",r,e);n(o,"Retrieving accountStore action is missing value for key: 'type'"),e.objectGraph.logger.debug(`ReadAccountStoreAction.perform(propName: ${a}, type: ${o})`);const c=e.objectGraph.accountStore;if(!(o in t))throw new Error(`The type (${o}) is not a valid type.`);const s=c[t[o]];if((0,je.isNothing)(a)||(0,je.isNothing)(s))return e.objectGraph.logger.debug(`ReadAccountStoreAction.perform(propName: ${a}, type: ${o}) -> ${i(s)}`),s;const u=e.objectReader.asValueType("propType"),l=new qe(s).asTypedValue(a,u);return n(l,`The requested property (${a}) does not exist in the ${s} account.`),e.objectGraph.logger.debug(`ReadAccountStoreAction.perform(propName: ${a}, type: ${o}) -> ${i(l)}`),l}}}(e);case"packageProperties":return function(e){let t;return function(e){e.version="version"}(t||(t={})),{perform:async r=>{const o=await p("key",r,e);if(e.objectGraph.logger.debug(`ReadPackagePropertiesAction.perform(key: ${o})`),n(o,"Package properties action is missing value for key: 'key'"),!(o in t))throw new Error(`The key (${o}) is not a valid package property.`);const a=e.objectGraph.packageProperties.version;return e.objectGraph.logger.debug(`ReadPackagePropertiesAction.perform(key: ${o}) -> ${i(a)}`),a}}}(e);case"client":return function(e){let t;return function(e){e.buildType="buildType",e.userAgent="userAgent",e.clientVersion="clientVersion"}(t||(t={})),{perform:async r=>{const o=await p("key",r,e);e.objectGraph.logger.debug(`ReadClientPropertiesAction.perform(key: ${o})`),n(o,"Client properties action is missing value for key: 'key'");const a=e.objectGraph.client;if(!(o in t))throw new Error(`The Key (${o}) does not exist in the Client object.`);const c=a[o];return e.objectGraph.logger.debug(`ReadClientPropertiesAction.perform(key: ${o}) -> ${i(c)}`),c}}}(e);case"readFromBag":return function(e){let t;return function(e){e.string="string",e.double="double",e.integer="integer",e.boolean="boolean",e.array="array",e.dictionary="dictionary",e.url="url"}(t||(t={})),{perform:async r=>{const o=await p("key",r,e),a=await p("type",r,e);if(e.objectGraph.logger.debug(`ReadFromBagAction.perform(key: ${o}, type: ${a})`),n(o,"Reading From Bag action is missing value for key: 'key'"),n(a,"Reading From Bag action is missing value for key: 'type'"),!(a in t))throw new Error(`The Type (${a}) must be one of [${Object.values(t)}].`);const c=e.objectGraph.bag[a](o);return e.objectGraph.logger.debug(`ReadFromBagAction.perform(key: ${o}, type: ${a}) -> ${i(c)}`),c}}}(e);case"idGenerator":return function(e){const t=I({idVersion:1,random:e.objectGraph.random});return{perform:async n=>{e.objectGraph.logger.debug("GenerateIdAction.perform");let r=null;const o=await p("storageKey",n,e),a=(0,je.isSome)(o);return a&&(r=e.objectGraph.database.fetch(o)),(0,je.isNothing)(r)&&(r=await(async()=>{const r=await f("version",n,e);return t.generate(r)})()),a&&e.objectGraph.database.set(o,r),e.objectGraph.logger.debug(`GenerateIdAction.perform -> ${i(r)}`),r}}}(e);case"privacyAcknowledgement":return function(e){let t=null;try{t=e.objectGraph.privacy}catch(t){e.objectGraph.logger.info("PrivacyAcknowledgementAction: The Privacy API is not available on this version.")}return{perform:async r=>{if(e.objectGraph.logger.debug("PrivacyAcknowledgementAction.perform"),(0,je.isNothing)(t))return null;const o=await p("privacyIdentifier",r,e),i=await l("account",r,e,"object");let a=null;n(o,"The provided privacyIdentifier does not exist in the action configuration."),(0,je.isSome)(i)&&(a={account:i});const c=await t.acknowledgementNeededForPrivacyIdentifier(o,a);return e.objectGraph.logger.debug(`PrivacyAcknowledgementAction.perform privacy identifier(${o}) -> needPrivacyConsent=${c}`),c}}}(e);case"readTreatmentByAreaId":return function(e){return{perform:async t=>{e.objectGraph.logger.debug("ReadTreatmentByAreaIdAction.perform");const r=e.objectGraph.treatmentStore;if((0,je.isNothing)(r))return e.objectGraph.logger.default("No A/B treatment store available"),null;const o=await p("areaId",t,e);n(o,"Read Treatment action is missing value for key: 'areaId'");const a=await r.fetchTreatments([o]);let c;return(0,je.isSome)(a)&&Object.keys(a).length>0?(e.objectGraph.logger.default(`Read treatment value: ${JSON.stringify(a[o])} for areaId ${o}`),c=a[o].identifier):e.objectGraph.logger.default(`No treatment found for areaId: ${o}`),e.objectGraph.logger.debug(`ReadTreatmentByAreaIdAction.perform -> ${i(null!=c?c:"No treatment found")}`),c}}}(e);default:throw new Error(`Unknown query action kind: ${t}`)}}async function K(e,t){const r={type:await p("type",e,t)};n(r.type,"Missing 'type' for backlog predicate"),r.app=await p("app",e,t),r.field=await p("field",e,t),r.pattern=await p("pattern",e,t),r.value=await g("value",e,t);const o=await l("conditions",e,t,"array");return(0,je.isSome)(o)&&(r.conditions=await Promise.all(o.map((n=>K(e,{...t,objectReader:new qe(n)}))))),r}function Q(e){return{perform:async t=>{const r=await p("mediaType",t,e);if(e.objectGraph.logger.debug(`ReadSubscriptionStatusAction.perform(mediaType: ${r})`),n(r,"Retrieving subscription action is missing value for key: 'mediaType'"),!(r in ce.SubscriptionMediaType))throw new Error(`${r} is not a valid subscription media type.`);const o=await e.objectGraph.subscription.lookup({type:ce.SubscriptionMediaType[r]});return e.objectGraph.logger.debug(`ReadSubscriptionStatusAction.perform(mediaType: ${r}) -> ${i(o)}`),o}}}function Z(e){const t=new Map;return{getQuery(r){if(t.has(r))return t.get(r);const o=e.objectReader.clone().select(r),i=function(e){const t=e.objectReader.asString("type");if("dynamic"!==t&&"static"!==t)throw new Error(`Unknown query type: ${t}`);let r;if(e.objectReader.has("defaultValue")){const t=e.objectReader.asValueType("defaultValue.type");r=e.objectReader.asTypedValue("defaultValue.value",t),n(r,"Query is missing value for key: 'default.value'")}e.objectReader.assertHasKey("action");const o=e.objectReader.select("action"),i=J({...e,objectReader:o});switch(t){case"dynamic":return function(e,t,n){return{perform:async r=>{e.objectGraph.logger.debug("Query.dynamic.process");const o=await t.perform(r);return e.objectGraph.logger.debug("Query.dynamic.process -> done"),null!=o?o:n}}}(e,i,r);case"static":return function(e,t,n){let r,o=!1;return{perform:async i=>{if(e.objectGraph.logger.debug("Query.static.process"),o)return e.objectGraph.logger.debug(`Query.static.process -> done (cached): ${r}`),r;const a=await t.perform(i);return o=!0,r=null!=a?a:n,e.objectGraph.logger.debug(`Query.static.process -> done: ${r}`),r}}}(e,i,r);default:throw new Error(`Unknown query type: ${t}`)}}({...e,queries:this,objectReader:o});return t.set(r,i),i}}}function X(e){const t=new Map;return{getValue(n){if(e.objectGraph.logger.debug(`MemoryCache.getValue.process: key: "${n}"`),t.has(n))return e.objectGraph.logger.debug(`MemoryCache.getValue.process -> done (cached): key: "${n}"`),t.get(n);const r=e.objectReader.clone().select(n),o=function(e,t){const n=t.objectReader.asValueType("valueType"),r=t.objectReader.asTypedValue("initValue",n);let o=null;return{set:async(r,a)=>{t.objectGraph.logger.debug(`MemoryCache.CachedValue.set.process: key: "${e}".`),o=await m(r,a,t,n),t.objectGraph.logger.debug(`MemoryCache.CachedValue.set.process (key: "${e}", value: ${i(o)}) -> done`)},load:async a=>(t.objectGraph.logger.debug(`MemoryCache.CachedValue.load.process: key: "${e}"`),(0,je.isSome)(o)?(t.objectGraph.logger.debug(`MemoryCache.CachedValue.load.process (key: "${e}", value: ${i(o)}) -> done (cached)`),o):(o=await m(r,a,t,n),t.objectGraph.logger.debug(`MemoryCache.CachedValue.load.process (key: "${e}", value: ${i(o)}) -> done`),o))}}(n,{...e,memoryCache:this,objectReader:r});return t.set(n,o),e.objectGraph.logger.debug(`MemoryCache.getValue.process -> done: key: "${n}"`),o}}}async function ee(e,t){return e.objectReader.assertHasKey(t),e.objectReader.assertHasKey(`${t}.namespace`),e.objectReader.assertHasKey(`${t}.key`),e.objectReader.assertHasKey(`${t}.crossDeviceSync`),{kind:null,fields:null,namespace:await p(`${t}.namespace`,{},e),key:await p(`${t}.key`,{},e),crossDeviceSync:await d(`${t}.crossDeviceSync`,{},e),excludeDebuggingFields:await d(`${t}.excludeDebuggingFields`,{},e)}}async function te(e,t,n,r){const o=V(),i=await o.applyWithFieldValue({value:null,field:null,eventFields:e,resolvedRuleConfig:r,context:{resolveRuleConfig:null,resolveEventFields:null,originalEventFields:null,random:null,metrics:t,accountStore:n}});e[r.key]=i}function ne(e,t){var r;e.assertHasKey("name");const o=e.asString("name");e.assertHasKey("groupConfig");const i=e.clone().select("groupConfig"),u=null!==(r=e.asNumber("executionTimeout"))&&void 0!==r?r:2e3;e.assertHasKey("pipelines");const l=e.applyTo((e=>e.select("pipelines").map((e=>function(e){const t=e.objectReader.asString("name"),r=e.objectReader.eventFilter;n(r,"Events pipeline is missing value for key: 'filter'"),e.objectReader.assertHasKey("actions");const o=e.objectReader.clone().select("config"),i=e.objectReader.clone().select("queries"),a=e.objectReader.clone().select("dynamicReferences"),u=e.objectReader.clone().select("memoryCache"),l={...e,pipelineConfigReader:o},f={...l,objectReader:i},d={...l,objectReader:a},p={...l,objectReader:u},v=Z(f),h=X(p),m=s(d);f.memoryCache=h,f.dynamicReferences=m,d.queries=v,d.memoryCache=h,p.queries=v,p.dynamicReferences=m;const b=e.objectReader.clone().select("actions").map((e=>q({...l,objectReader:e.clone(),dynamicReferences:m,queries:v,memoryCache:h})));if(0===b.length)throw new Error("Events pipeline has 0 actions");return{eventFilter:r,process:async n=>{if(e.objectGraph.logger.default(`EventPipeline[${t}].process`),!c(n,r))return e.objectGraph.logger.default(`EventPipeline[${t}].process -> failed filter test`),n;let o=n;for(const e of b)if(o=await e.process(o),(0,je.isNothing)(o))break;return e.objectGraph.logger.default(`EventPipeline[${t}].process -> done`),o}}}({objectReader:e.clone(),groupConfigReader:i,objectGraph:t})))));if(0===l.length)throw new Error("No pipelines configured for pipeline group");const f=l.reduce(((e,t)=>[...e,t.eventFilter]),[]);let d,p;if(d=e.has("outputActions")?e.applyTo((e=>e.select("outputActions").map((e=>function(e){const t=e.objectReader.asString("kind");if("enqueueEvents"===t)return function(e){const t=B(e);return{process:async n=>{e.objectGraph.logger.info("EnqueueEventsOutputAction.process");const r=[];n.forEach((e=>{r.push(t.process(e))})),await Promise.all(r),e.objectGraph.logger.info("EnqueueEventsOutputAction.process -> done")}}}(e);throw new Error(`Unknown pipeline group output action kind: ${t}`)}({objectReader:e.clone(),groupConfigReader:i,objectGraph:t}))))):[],e.has("onSync")){if(p=e.applyTo((e=>e.select("onSync").map((e=>function(e){const t=e.objectReader.asString("name"),n=e.objectReader.clone().select("config"),r=e.objectReader.clone().select("queries"),o=e.objectReader.clone().select("memoryCache"),i=e.objectReader.clone().select("dynamicReferences"),a={...e,pipelineConfigReader:n};e.objectReader.assertHasKey("actions");const c=e.objectReader.clone().select("actions"),u={...a,objectReader:r},l={...a,objectReader:i},f={...a,objectReader:o},d=Z(u),p=X(f),v=s(l);u.memoryCache=p,u.dynamicReferences=v,l.queries=d,l.memoryCache=p,f.queries=d,f.dynamicReferences=v;const h=c.map((e=>function(e){const t=e.objectReader.asString("kind");if("generateEvent"===t)return function(e){const t=C(e),n=function(e){if(e.objectReader.has("addCommonFieldsAction"))return H({...e,objectReader:e.objectReader.clone().select("addCommonFieldsAction")});if("account"===e.objectReader.asString("eventType")){const t=new qe({kind:"addCommonFields"});return H({...e,objectReader:t})}return null}(e);return{process:async()=>{if(e.objectGraph.logger.info("GenerateEventAction.sync"),await async function(e){return!!(0,je.isSome)(e)&&!await e.test({})}(t))return e.objectGraph.logger.info("GenerateEventAction.sync -> predicate test failed"),null;let r={};const o=await async function(e){const t=e.objectReader.asString("eventType");switch(t){case"account":{e.objectReader.assertHasKey("fields.app"),e.objectReader.assertHasKey("fields.topic"),e.objectReader.assertHasKey("fields.eventVersion");const t=await ee(e,"clientIdConfig"),a=await ee(e,"userIdConfig"),c=e.objectGraph.accountStore,s=Q(e),u=await s.perform({}),l=[];if((0,je.isSome)(u)){const e=u;if((0,je.isSome)(e.entitlements))for(const[t,a]of Object.entries(e.entitlements))l.push((r=void 0,o=void 0,i=void 0,{autoRenew:(n=a).autoRenewEnabled,chargeStoreFrontId:n.chargeStoreFrontID,entitlementOriginType:n.entitlementOriginType,expireDate:1e3*n.expiration,featureAccessTypeId:null===(r=n.featureAccessTypeId)||void 0===r?void 0:r.toString(),freeTrialPeriodId:null===(o=n.freeTrialPeriodId)||void 0===o?void 0:o.toString(),inAppAdamId:null===(i=n.inAppAdamId)||void 0===i?void 0:i.toString(),initialPurchaseTimestamp:n.initialPurchaseTimestamp,isGracePeriod:n.inGracePeriod,isOfferPeriod:n.inOfferPeriod,isPurchaser:n.purchaser,isTrialPeriod:n.inTrialPeriod,offerIdentifier:n.offerId,serviceBeginsTimestamp:n.serviceBeginsTimestamp,startDate:1*n.startDate,vendorAdHocOfferId:n.vendorAdHocOfferId}))}if(0===l.length)return e.objectGraph.logger.info("GenerateEventAction.sync -> inAppSubscriptions is empty, skip generating account event."),null;const f={app:{kind:"reference",reference:e.objectReader.asString("fields.app"),valueType:"string"},eventVersion:{kind:"reference",reference:e.objectReader.asString("fields.eventVersion"),valueType:"number"},isAnonymous:{kind:"value",value:!0},topic:{kind:"reference",reference:e.objectReader.asString("fields.topic"),valueType:"string"},userAgent:{kind:"reference",reference:e.objectGraph.client.userAgent,valueType:"string"},eventType:{kind:"value",value:"account"},inAppSubscriptions:{kind:"value",value:l}};return await Promise.all([te(f,e.objectGraph.metrics,c,t),te(f,e.objectGraph.metrics,c,a)]),f}case"custom":{e.objectReader.assertHasKey("fields");const t=e.objectReader.asObjectType("fields");if(t.constructor===Object)return t;throw new Error("The fields entry is not an object")}default:throw new Error(`Unknown generate event action eventType: ${t}`)}var n,r,o,i}(e);if((0,je.isSome)(o)){if(0===Object.keys(o).length)throw new Error("Empty event generator spec");(0,je.isSome)(n)&&(r=await n.process(r));for(const[t,n]of Object.entries(o)){const o=await b(t,{},e);let i;switch(n.kind){case"value":i=n.value;break;case"reference":i=await m(n.reference,{},e,n.valueType);break;default:if("string"!=typeof n&&"boolean"!=typeof n)throw new Error("Unknown field generator spec kind");i=n}r[o]=i}}else e.objectGraph.logger.info("GenerateEventAction.sync -> no source spec generated");return e.objectGraph.logger.info("GenerateEventAction.sync -> done"),Object.keys(r).length>0?r:null}}}(e);try{return n=q(e),{process:e=>n.process(null!=e?e:{})}}catch(e){if((0,je.isSome)(e.message)&&e.message.startsWith("Unknown event action kind"))throw new Error(`Unknown sync action kind: ${t}`);throw e}var n}({...a,objectReader:e.clone(),dynamicReferences:v,queries:d,memoryCache:p})));if(0===h.length)throw new Error(`No actions configured for the sync pipeline[${t}]`);return{process:async()=>{e.objectGraph.logger.default(`SyncPipeline[${t}].process`);let n={};for(const e of h)if(n=await e.process(n),(0,je.isNothing)(n))break;return e.objectGraph.logger.default(`SyncPipeline[${t}].process -> done`),n}}}({objectReader:e.clone(),groupConfigReader:i,objectGraph:t}))))),0===p.length)throw new Error("No pipeline configured for onSync handler")}else p=[];return{name:o,eventFilters:f,process:e=>{return t.logger.default(`PipelineGroup[${o}].process`),n=t.timer,r=u,i=async()=>{const n=e.filter((e=>f.some((t=>c(e,t))))),r=[],i=[];for(const e of n){let t=e;for(const e of l){if((0,je.isNothing)(t))break;t=await e.process(t)}(0,je.isSome)(t)&&r.push(t)}for(const e of d)i.push(e.process(r));return Promise.all(i).then((()=>{t.logger.default(`PipelineGroup[${o}].process -> done`)}))},new Promise(((e,t)=>{const o=n.setTimeout((()=>{n.clearTimeout(o),t(new Error("Some promises in the group pipeline timed out"))}),r);i().then((()=>{n.clearTimeout(o),e()})).catch(t)}));var n,r,i},sync:async()=>{if(t.logger.default(`PipelineGroup[${o}].sync performing ${p.length} pipelines`),0===p.length)return t.logger.default(`PipelineGroup[${o}].sync -> no pipelines to run on sync`),Promise.resolve();const e=[],n=p.map((n=>n.process().then((t=>{e.push(t)})).catch((e=>{t.logger.error(`Error while processing events by the sync pipeline of the group: ${o}, error: ${a(e.message||e)}`)}))));return Promise.all(n).then((()=>{const t=[];for(const n of d)t.push(n.process(e));return Promise.all(t)})).then((()=>{})).finally((()=>{t.logger.default(`PipelineGroup[${o}].sync -> done`)}))}}}function re(e,t){const n=new qe(e);t.logger.setLogLevel(n.asString("logLevel"));const r=n.applyTo((e=>(e.assertHasKey("pipelineGroups"),e.select("pipelineGroups").compactMap((e=>{try{return ne(e,t)}catch(n){return t.logger.error(`Error while building pipeline group from object at path: ${e.currentKeyPath.toString()}, error: ${n}`),null}})))));if(0===r.length)throw new Error("No pipeline groups configured for app pipeline");return{eventFilters:r.reduce(((e,t)=>[...e,...t.eventFilters]),[]),process:e=>oe(r,(async n=>{try{return await n.process(e)}catch(e){t.logger.error(`Error while processing events by pipeline group: ${n.name}, error: ${a(e.message||e)}`)}})),sync:async()=>(t.logger.default("AppPipeline.sync"),oe(r,(async e=>{try{return await e.sync()}catch(n){t.logger.error(`Error while running onSync handler for pipeline group: ${e.name}, error: ${a(n.message||n)}`)}})))}}async function oe(e,t){const n=[];for(const r of e)n.push(t(r));await Promise.all(n)}var ie,ae,ce,se,ue,le,fe,de,pe,ve,he,me,be,ye,ge,we,_e,je=e(2450),Oe=e(9100),ke=e(1222),Me=e(900);class Ae{get version(){return"21.0.69"}}Ae.type=(0,Me.makeMetatype)("app:package-properties");class Se{constructor(e){this.implementation=e}}class Te extends Se{get buildType(){return"debug"}get userAgent(){return this.implementation.userAgent}get clientVersion(){return this.implementation.clientVersion}}Te.type=(0,Me.makeMetatype)("app:client-wrapper"),ie=e(5542),function(e){e[e.debug=0]="debug",e[e.info=1]="info",e[e.default=2]="default",e[e.error=3]="error"}(ae||(ae={}));class Ee extends Se{constructor(){super(...arguments),this.logLevel=ae.default}static decorate(e){return[Ee.PREFIX,e].join(" ")}isLogEnabled(e){return e>=this.logLevel}logMessage(e,t){this.isLogEnabled(e)&&this.implementation[ae[e]](Ee.decorate(t))}setLogLevel(e){const t=ae[e];(0,ie.isSome)(t)&&(this.implementation.default(Ee.decorate(`Log Level: ${ae[t]}`)),this.logLevel=t)}debug(e){this.logMessage(ae.debug,e)}info(e){this.logMessage(ae.info,e)}default(e){this.logMessage(ae.default,e)}error(e){this.logMessage(ae.error,e)}}Ee.type=(0,Me.makeMetatype)("app:log-wrapper"),Ee.PREFIX="[Analytics]";class $e extends Se{setTimeout(e,t){if("function"==typeof this.implementation.setTimeout)return this.implementation.setTimeout(e,t)}clearTimeout(e){"function"==typeof this.implementation.clearTimeout&&(0,je.isSome)(e)&&this.implementation.clearTimeout(e)}}$e.type=(0,Me.makeMetatype)("app:timer-wrapper");const Ce=(0,Me.makeMetatype)("app:database"),De=(0,Me.makeMetatype)("app:backlog"),Ne=(0,Me.makeMetatype)("app:metrics"),Re=(0,Me.makeMetatype)("app:subscription"),Pe=((0,Me.makeMetatype)("app:accountStore"),(0,Me.makeMetatype)("app:configService")),xe=(0,Me.makeMetatype)("app:host"),Fe=(0,Me.makeMetatype)("app:bag"),Ie=(0,Me.makeMetatype)("app:privacy"),Ve=(0,Me.makeMetatype)("app:treatmentStore");class Ye extends Se{get isSignedIn(){return(0,je.isSome)(this.implementation.activeiTunes)}get activeiTunes(){return this.implementation.activeiTunes}get activeiCloud(){return this.implementation.activeiCloud}activeiTunesForMediaType(e){return this.implementation.activeiTunesForMediaType(e)}localAccountForMediaType(e){return this.implementation.localAccountForMediaType(e)}}Ye.type=(0,Me.makeMetatype)("app:accountStore-wrapper");class Le extends Oe.ObjectGraph{configureDefaults(e,t,n,r,o,i,a,c,s,u,l,f,d,p){return this.addingRandom(e).addingNetwork(t).addingTimer(n).addingLogger(i).addingClient(a).addingDatabase(c).addingBacklog(s).addingMetrics(u).addingSubscription(l).addingAccountStore(f).addingHost(r).addingBag(o).addingPrivacy(d).addingTreatmentStore(p)}get random(){return this.required(ke.random)}addingRandom(e){return this.adding(ke.random,e)}get network(){return this.required(ke.net)}addingNetwork(e){return this.adding(ke.net,e)}get timer(){return this.required($e.type)}addingTimer(e){return this.addingTimerWrapper(new $e(e))}addingTimerWrapper(e){return this.adding($e.type,e)}get logger(){return this.required(Ee.type)}addingLogger(e){return this.addingLoggerWrapper(new Ee(e))}addingLoggerWrapper(e){return this.adding(Ee.type,e)}get client(){return this.required(Te.type)}addingClient(e){return this.addingClientWrapper(new Te(e))}addingClientWrapper(e){return this.adding(Te.type,e)}get database(){return this.required(Ce)}addingDatabase(e){return this.adding(Ce,e)}get backlog(){return this.required(De)}addingBacklog(e){return this.adding(De,e)}get metrics(){return this.required(Ne)}addingMetrics(e){return this.adding(Ne,e)}get subscription(){return this.required(Re)}addingSubscription(e){return this.adding(Re,e)}get packageProperties(){return this.required(Ae.type)}addingPackageProperties(e){return this.adding(Ae.type,e)}get accountStore(){return this.required(Ye.type)}addingAccountStore(e){return this.addingAccountStoreWrapper(new Ye(e))}addingAccountStoreWrapper(e){return this.adding(Ye.type,e)}get configService(){return this.required(Pe)}addingConfigService(e){return this.adding(Pe,e)}get host(){return this.required(xe)}addingHost(e){return this.adding(xe,e)}get bag(){return this.required(Fe)}addingBag(e){return this.adding(Fe,e)}get privacy(){return this.required(Ie)}addingPrivacy(e){return this.adding(Ie,e)}addingTreatmentStore(e){return this.adding(Ve,e)}get treatmentStore(){return this.required(Ve)}}let Ue=null;ce=e(9089),se=e(1077);class qe extends se.ObjectReader{select(e,t=!1){return super.select(e,!0)}get eventFilter(){return this.get("filter")}asTypedValue(e,t){switch(t){case"string":return this.asString(e);case"number":return this.asNumber(e);case"boolean":return this.asBoolean(e);case"object":return this.asObjectType(e);case"array":return this.asArrayType(e);case"any":return this.asAnyType(e);default:throw new Error(`Unknown value type: ${t}`)}}asValueType(e){const t=this.asString(e);switch(t){case"string":case"number":case"boolean":case"object":case"array":return t;default:throw new Error(`Unknown value type: ${t}`)}}asObjectType(e=[]){return r(this.get(e))}asArrayType(e=[]){return o(this.get(e))}asAnyType(e=[]){return this.get(e)}assertHasKey(e){if(!this.has(e))throw new Error(`Value for key '${String(e)}' does not exist in object reader at path: ${this.currentKeyPath.toString()}`)}}ue=e(8535),le=e(6418),fe=e(2506),function(e){e.addition="addition",e.subtraction="subtraction",e.multiplication="multiplication",e.division="division"}(de||(de={})),pe=e(8950),function(e){e.ORIGINAL_EVENT="ORIGINAL_EVENT",e.PROCESSING_EVENT="PROCESSING_EVENT"}(ve||(ve={})),function(e){e.Hostname="hostname",e.FullWithoutParams="fullWithoutParams"}(he||(he={})),function(e){e.memoryCache="memoryCache",e.database="database"}(me||(me={})),be=e(7771);const Be="linter_timeSequence",He=100;ye=e(7322),ge=e.n(ye),we=e(8063),_e=e.n(we);const ze=["YYYY-MM-DD HH:mm:ss ZZ","MM-DD-YYYY","YYYY-MM-DD HH:mm:ss","DD-MM-YYYY HH:mm:ss"];ge().extend(_e()),function(e,t){const n="config",r={async enqueue(t){const r=e.objectGraph;r.logger.default("EngagementService.enqueue"),r.logger.default(`Client: ${a(t.client)}`),r.logger.default(`Events: ${i(t.events)}`),r.logger.default(`Loading cached config with name: ${n}`);const o=r.configService.getCachedConfig(n);if((0,je.isNothing)(o))throw new Error(`No cached config found for name: ${n}`);r.logger.default("Creating app pipeline");const c=re(o.source,r);return r.logger.default(`Processing ${t.events.length} event(s)`),await c.process(t.events),r.logger.default("EngagementService.enqueue -> done"),{data:{}}},async sync(t){const r=e.objectGraph;r.logger.default("EngagementService.sync"),r.logger.default(`EngagementService.sync: fetching config with name: ${n}`);const o=await r.configService.syncConfig(n);r.logger.default("EngagementService.sync: creating app pipeline");const i=re(o.source,r),c=i.eventFilters.map((e=>({allowsResponse:!1,filter:e})));let s=(0,le.valueAsNumber)(o.source.backlogSizeLimit);return s=Number.isNaN(s)||s<=0?null:s,r.logger.default("EngagementService.sync: running pipeline sync"),await i.sync(),r.logger.default(`EngagementService.sync -> backlog-size-limit = ${s}`),r.logger.default(`EngagementService.sync -> allow-list: ${a(c)}`),{backlog:{enabled:!0,sizeLimit:s},allowedEvents:c,whitelistedEvents:void 0}}};(0,ce.exportEngagementService)(r)}({get objectGraph(){return(0,je.isNothing)(Ue)&&(Ue=function(){const e=function(){const e=AMS.database.create({});if((0,je.isSome)(e.error))throw new Error(`Failed to create AMS database connection: ${e.error}`);const t=e.result;return n=new Le("app"),r=globalThis.random,o=globalThis.net,i=globalThis,a=globalThis.host,c=globalThis.bag,s=AMS.log,u=AMS.client,l=t,f=AMS.backlog,d=AMS.metrics,p=AMS.subscription,v=AMS.accounts,h=AMS.privacy,m=AMS.treatmentStore,n.configureDefaults(r,o,i,a,c,s,u,l,f,d,p,v,h,m);var n,r,o,i,a,c,s,u,l,f,d,p,v,h,m}(),t=function(e){function t(e){return`config.${e}`}const n=new Map;return{syncConfig:async r=>{const o=await async function(t){const n=await e.network.fetch({url:`https://apps.mzstatic.com/content/658ccf7e0803483f9c8799a2a8bf3c03/${t}.json`,method:"GET"});if(!n.ok||n.status<200||n.status>=300){const r=`Unable to fetch configuration for the topic "${t}". status: ${n.status}, status text: ${n.statusText}`;throw e.logger.error(r),new Error(r)}try{return JSON.parse(n.body)}catch(n){const r=`Unable to parse the configuration for the topic "${t}" due to ${n}`;throw e.logger.error(r),new SyntaxError(r)}}(r);return function(r,o){e.database.set(t(r),JSON.stringify(o)),n.set(r,o)}(r,o),{name:r,source:o}},getCachedConfig:r=>{const o=function(r){let o=n.get(r);if((0,je.isSome)(o))return o;const i=e.database.fetch(t(r));if((0,je.isNothing)(i))return e.logger.error("Empty configuration body fetched from storage"),null;try{o=JSON.parse(i),n.set(r,o)}catch(t){return e.logger.error(`Unable to parse the configSource when loading the config from the storage due to: ${t}`),null}return o}(r);return(0,je.isNothing)(o)?null:{name:r,source:o}},cleanup:()=>{n.clear()}}}(e);return e.addingPackageProperties(new Ae).addingConfigService(t)}()),Ue},restart:()=>{Ue=null}})})()})();
//# sourceMappingURL=3540befb7d278e0dd245.js.map